import { ContentAccessEntry, ContentEntry, ContentMarkerEntry } from '../db/schema';
import { ContentUtil } from './content-util';
import { CsContentType } from '@project-sunbird/client-services/services/content';
import { TrackingEnabled } from '@project-sunbird/client-services/models';
import { CsPrimaryCategoryMapper } from '@project-sunbird/client-services/services/content/utilities/primary-category-mapper';
var ContentMapper = /** @class */ (function () {
    function ContentMapper() {
    }
    ContentMapper.mapContentDataToContentDBEntry = function (contentData, manifestVersion) {
        var _a;
        var serverLastUpdatedOn;
        var serverData;
        var localData;
        if (!manifestVersion) {
            serverLastUpdatedOn = contentData.lastUpdatedOn;
            serverData = JSON.stringify(contentData);
        }
        else {
            localData = JSON.stringify(contentData);
        }
        return _a = {},
            _a[ContentEntry.COLUMN_NAME_IDENTIFIER] = contentData.identifier,
            _a[ContentEntry.COLUMN_NAME_SERVER_DATA] = serverData,
            _a[ContentEntry.COLUMN_NAME_SERVER_LAST_UPDATED_ON] = serverLastUpdatedOn,
            _a[ContentEntry.COLUMN_NAME_MANIFEST_VERSION] = manifestVersion,
            _a[ContentEntry.COLUMN_NAME_LOCAL_DATA] = localData,
            _a[ContentEntry.COLUMN_NAME_MIME_TYPE] = contentData.mimeType,
            _a[ContentEntry.COLUMN_NAME_CONTENT_TYPE] = ContentUtil.readContentType(contentData),
            _a[ContentEntry.COLUMN_NAME_VISIBILITY] = ContentUtil.readVisibility(contentData),
            _a[ContentEntry.COLUMN_NAME_AUDIENCE] = ContentUtil.readAudience(contentData),
            _a[ContentEntry.COLUMN_NAME_PRAGMA] = ContentUtil.readPragma(contentData),
            _a[ContentEntry.COLUMN_NAME_PRIMARY_CATEGORY] = ContentUtil.readPrimaryCategory(contentData),
            _a;
    };
    ContentMapper.mapServerResponseToContent = function (contentData, manifestVersion) {
        var serverLastUpdatedOn;
        var serverData;
        var localData;
        if (!manifestVersion) {
            serverLastUpdatedOn = contentData.lastUpdatedOn;
            serverData = contentData;
        }
        else {
            localData = contentData;
        }
        if (!contentData.primaryCategory && contentData.contentType && contentData.mimeType) {
            contentData.primaryCategory = CsPrimaryCategoryMapper.getPrimaryCategory(contentData.contentType.toLowerCase(), contentData.mimeType, contentData.resourceType);
        }
        var primaryCategory = contentData.primaryCategory ? contentData.primaryCategory : contentData.contentType;
        if (!contentData.trackable && primaryCategory && primaryCategory.toLowerCase() === CsContentType.COURSE.toLowerCase()) {
            contentData.trackable = {
                enabled: TrackingEnabled.YES
            };
        }
        if (!contentData.trackable) {
            contentData.trackable = {
                enabled: TrackingEnabled.NO
            };
        }
        return {
            identifier: contentData.identifier,
            name: contentData.name,
            contentData: contentData,
            isUpdateAvailable: ContentUtil.isUpdateAvailable(serverData, localData),
            mimeType: contentData.mimeType,
            basePath: '',
            contentType: ContentUtil.readContentType(contentData),
            primaryCategory: ContentUtil.readPrimaryCategory(contentData),
            isAvailableLocally: false,
            referenceCount: 0,
            sizeOnDevice: 0,
            lastUsedTime: 0,
            lastUpdatedTime: 0,
        };
    };
    ContentMapper.mapContentDBEntryToContent = function (contentEntry, shouldConvertBasePath) {
        var contentData;
        var serverInfo = contentEntry[ContentEntry.COLUMN_NAME_SERVER_DATA];
        var localInfo = contentEntry[ContentEntry.COLUMN_NAME_LOCAL_DATA];
        var serverData = serverInfo && JSON.parse(serverInfo);
        var localData = localInfo && JSON.parse(localInfo);
        var identifier = contentEntry[ContentEntry.COLUMN_NAME_IDENTIFIER];
        var mimeType = contentEntry[ContentEntry.COLUMN_NAME_MIME_TYPE];
        var visibility = contentEntry[ContentEntry.COLUMN_NAME_VISIBILITY];
        var contentType = contentEntry[ContentEntry.COLUMN_NAME_CONTENT_TYPE];
        var primaryCategory = contentEntry[ContentEntry.COLUMN_NAME_PRIMARY_CATEGORY];
        var lastUsedTime = 0;
        var resourceType;
        if (contentEntry.hasOwnProperty(ContentAccessEntry.COLUMN_NAME_EPOCH_TIMESTAMP)) {
            lastUsedTime = contentEntry[ContentAccessEntry.COLUMN_NAME_EPOCH_TIMESTAMP];
        }
        if (contentEntry.hasOwnProperty(ContentMarkerEntry.COLUMN_NAME_DATA)) {
            if (!localData) {
                localData = JSON.parse(contentEntry[ContentMarkerEntry.COLUMN_NAME_DATA]);
            }
            if (localData) {
                identifier = localData.identifier;
                mimeType = localData.mimeType;
                resourceType = localData.resourceType;
                visibility = ContentUtil.readVisibility(localData);
                contentType = ContentUtil.readContentType(localData);
                primaryCategory = ContentUtil.readPrimaryCategory(localData);
            }
        }
        if (localData) {
            contentData = localData;
        }
        if (serverData) {
            if (!localData || !ContentUtil.isAvailableLocally(contentEntry[ContentEntry.COLUMN_NAME_CONTENT_STATE])) {
                contentData = serverData;
            }
            else {
                if (!localData.streamingUrl) {
                    localData.streamingUrl = serverData.streamingUrl;
                }
                if (!localData.previewUrl) {
                    localData.previewUrl = serverData.previewUrl;
                }
                if (serverData.me_totalRatingsCount) {
                    localData.me_totalRatingsCount = serverData.me_totalRatingsCount;
                }
                if (serverData.me_averageRating) {
                    localData.me_averageRating = serverData.me_averageRating;
                }
                if (!localData.size) {
                    localData.size = serverData.size;
                }
                if (serverData.licenseDetails) {
                    localData.licenseDetails = serverData.licenseDetails;
                }
                if (serverData.forumId) {
                    localData.forumId = serverData.forumId;
                }
            }
        }
        var contentCreationTime = 0;
        var localLastUpdatedTime = contentEntry[ContentEntry.COLUMN_NAME_LOCAL_LAST_UPDATED_ON];
        if (localLastUpdatedTime) {
            contentCreationTime = new Date(localLastUpdatedTime).getTime();
        }
        var sizeOnDevice = Number(contentEntry[ContentEntry.COLUMN_NAME_SIZE_ON_DEVICE]);
        var size = sizeOnDevice ? sizeOnDevice : Number(serverData ? serverData.size : 0);
        if (!contentData.trackable && primaryCategory && primaryCategory.toLowerCase() === CsContentType.COURSE.toLowerCase()) {
            contentData.trackable = {
                enabled: TrackingEnabled.YES
            };
        }
        if (!contentData.trackable) {
            contentData.trackable = {
                enabled: TrackingEnabled.NO
            };
        }
        resourceType = contentData.resourceType;
        if (!contentData.primaryCategory && contentType) {
            contentData.primaryCategory = CsPrimaryCategoryMapper.getPrimaryCategory(contentType.toLowerCase(), mimeType, resourceType);
        }
        var basePath = contentEntry[ContentEntry.COLUMN_NAME_PATH] || '';
        if (typeof (contentData.originData) === 'string') {
            contentData.originData = ContentUtil.getParseErrorObject(contentData.originData);
        }
        if (contentData.trackable && typeof (contentData.trackable) === 'string') {
            contentData.trackable = JSON.parse(contentData.trackable);
        }
        return {
            identifier: identifier,
            name: contentData.name,
            contentData: contentData,
            isUpdateAvailable: ContentUtil.isUpdateAvailable(serverData, localData),
            mimeType: mimeType,
            basePath: !shouldConvertBasePath ? basePath : '/_app_file_' + basePath,
            primaryCategory: primaryCategory,
            contentType: contentType,
            isAvailableLocally: ContentUtil.isAvailableLocally(contentEntry[ContentEntry.COLUMN_NAME_CONTENT_STATE]),
            referenceCount: Number(contentEntry[ContentEntry.COLUMN_NAME_REF_COUNT]) || 0,
            sizeOnDevice: size,
            lastUsedTime: lastUsedTime || 0,
            lastUpdatedTime: contentCreationTime,
        };
    };
    return ContentMapper;
}());
export { ContentMapper };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGVudC1tYXBwZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY29udGVudC91dGlsL2NvbnRlbnQtbWFwcGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxrQkFBa0IsRUFBRSxZQUFZLEVBQUUsa0JBQWtCLEVBQUMsTUFBTSxjQUFjLENBQUM7QUFFbEYsT0FBTyxFQUFDLFdBQVcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQzNDLE9BQU8sRUFBQyxhQUFhLEVBQUMsTUFBTSxtREFBbUQsQ0FBQztBQUNoRixPQUFPLEVBQUMsZUFBZSxFQUFDLE1BQU0seUNBQXlDLENBQUM7QUFDeEUsT0FBTyxFQUFDLHVCQUF1QixFQUFDLE1BQU0scUZBQXFGLENBQUM7QUFFNUg7SUFBQTtJQXlMQSxDQUFDO0lBeExlLDRDQUE4QixHQUE1QyxVQUE2QyxXQUFXLEVBQUUsZUFBdUI7O1FBQy9FLElBQUksbUJBQW1CLENBQUM7UUFDeEIsSUFBSSxVQUFVLENBQUM7UUFDZixJQUFJLFNBQVMsQ0FBQztRQUNkLElBQUksQ0FBQyxlQUFlLEVBQUU7WUFDcEIsbUJBQW1CLEdBQUcsV0FBVyxDQUFDLGFBQWEsQ0FBQztZQUNoRCxVQUFVLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQztTQUMxQzthQUFNO1lBQ0wsU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLENBQUM7U0FDekM7UUFDRDtZQUNFLEdBQUMsWUFBWSxDQUFDLHNCQUFzQixJQUFHLFdBQVcsQ0FBQyxVQUFVO1lBQzdELEdBQUMsWUFBWSxDQUFDLHVCQUF1QixJQUFHLFVBQVU7WUFDbEQsR0FBQyxZQUFZLENBQUMsa0NBQWtDLElBQUcsbUJBQW1CO1lBQ3RFLEdBQUMsWUFBWSxDQUFDLDRCQUE0QixJQUFHLGVBQWU7WUFDNUQsR0FBQyxZQUFZLENBQUMsc0JBQXNCLElBQUcsU0FBUztZQUNoRCxHQUFD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WSxFQUFFLFlBQVksSUFBSSxDQUFDO1lBQy9CLGVBQWUsRUFBRSxtQkFBbUI7U0FDckMsQ0FBQztJQUNKLENBQUM7SUFDSCxvQkFBQztBQUFELENBQUMsQUF6TEQsSUF5TEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0NvbnRlbnRBY2Nlc3NFbnRyeSwgQ29udGVudEVudHJ5LCBDb250ZW50TWFya2VyRW50cnl9IGZyb20gJy4uL2RiL3NjaGVtYSc7XG5pbXBvcnQge0NvbnRlbnQsIENvbnRlbnREYXRhfSBmcm9tICcuLic7XG5pbXBvcnQge0NvbnRlbnRVdGlsfSBmcm9tICcuL2NvbnRlbnQtdXRpbCc7XG5pbXBvcnQge0NzQ29udGVudFR5cGV9IGZyb20gJ0Bwcm9qZWN0LXN1bmJpcmQvY2xpZW50LXNlcnZpY2VzL3NlcnZpY2VzL2NvbnRlbnQnO1xuaW1wb3J0IHtUcmFja2luZ0VuYWJsZWR9IGZyb20gJ0Bwcm9qZWN0LXN1bmJpcmQvY2xpZW50LXNlcnZpY2VzL21vZGVscyc7XG5pbXBvcnQge0NzUHJpbWFyeUNhdGVnb3J5TWFwcGVyfSBmcm9tICdAcHJvamVjdC1zdW5iaXJkL2NsaWVudC1zZXJ2aWNlcy9zZXJ2aWNlcy9jb250ZW50L3V0aWxpdGllcy9wcmltYXJ5LWNhdGVnb3J5LW1hcHBlcic7XG5cbmV4cG9ydCBjbGFzcyBDb250ZW50TWFwcGVyIHtcbiAgcHVibGljIHN0YXRpYyBtYXBDb250ZW50RGF0YVRvQ29udGVudERCRW50cnkoY29udGVudERhdGEsIG1hbmlmZXN0VmVyc2lvbjogc3RyaW5nKTogQ29udGVudEVudHJ5LlNjaGVtYU1hcCB7XG4gICAgbGV0IHNlcnZlckxhc3RVcGRhdGVkT247XG4gICAgbGV0IHNlcnZlckRhdGE7XG4gICAgbGV0IGxvY2FsRGF0YTtcbiAgICBpZiAoIW1hbmlmZXN0VmVyc2lvbikge1xuICAgICAgc2VydmVyTGFzdFVwZGF0ZWRPbiA9IGNvbnRlbnREYXRhLmxhc3RVcGRhdGVkT247XG4gICAgICBzZXJ2ZXJEYXRhID0gSlNPTi5zdHJpbmdpZnkoY29udGVudERhdGEpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2NhbERhdGEgPSBKU09OLnN0cmluZ2lmeShjb250ZW50RGF0YSk7XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICBbQ29udGVudEVudHJ5LkNPTFVNTl9OQU1FX0lERU5USUZJRVJdOiBjb250ZW50RGF0YS5pZGVudGlmaWVyLFxuICAgICAgW0NvbnRlbnRFbnRyeS5DT0xVTU5fTkFNRV9TRVJWRVJfREFUQV06IHNlcnZlckRhdGEsXG4gICAgICBbQ29udGVudEVudHJ5LkNPTFVNTl9OQU1FX1NFUlZFUl9MQVNUX1VQREFURURfT05dOiBzZXJ2ZXJMYXN0VXBkYXRlZE9uLFxuICAgICAgW0NvbnRlbnRFbnRyeS5DT0xVTU5fTkFNRV9NQU5JRkVTVF9WRVJTSU9OXTogbWFuaWZlc3RWZXJzaW9uLFxuICAgICAgW0NvbnRlbnRFbnRyeS5DT0xVTU5fTkFNRV9MT0NBTF9EQVRBXTogbG9jYWxEYXRhLFxuICAgICAgW0NvbnRlbnRFbnRyeS5DT0xVTU5fTkFNRV9NSU1FX1RZUEVdOiBjb250ZW50RGF0YS5taW1lVHlwZSxcbiAgICAgIFtDb250ZW50RW50cnkuQ09MVU1OX05BTUVfQ09OVEVOVF9UWVBFXTogQ29udGVudFV0aWwucmVhZENvbnRlbnRUeXBlKGNvbnRlbnREYXRhKSxcbiAgICAgIFtDb250ZW50RW50cnkuQ09MVU1OX05BTUVfVklTSUJJTElUWV06IENvbnRlbnRVdGlsLnJlYWRWaXNpYmlsaXR5KGNvbnRlbnREYXRhKSxcbiAgICAgIFtDb250ZW50RW50cnkuQ09MVU1OX05BTUVfQVVESUVOQ0VdOiBDb250ZW50VXRpbC5yZWFkQXVkaWVuY2UoY29udGVudERhdGEpLFxuICAgICAgW0NvbnRlbnRFbnRyeS5DT0xVTU5fTkFNRV9QUkFHTUFdOiBDb250ZW50VXRpbC5yZWFkUHJhZ21hKGNvbnRlbnREYXRhKSxcbiAgICAgIFtDb250ZW50RW50cnkuQ09MVU1OX05BTUVfUFJJTUFSWV9DQVRFR09SWV06IENvbnRlbnRVdGlsLnJlYWRQcmltYXJ5Q2F0ZWdvcnkoY29udGVudERhdGEpXG4gICAgfTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgbWFwU2VydmVyUmVzcG9uc2VUb0NvbnRlbnQoY29udGVudERhdGEsIG1hbmlmZXN0VmVyc2lvbj86IHN0cmluZyk6IENvbnRlbnQge1xuICAgIGxldCBzZXJ2ZXJMYXN0VXBkYXRlZE9uO1xuICAgIGxldCBzZXJ2ZXJEYXRhO1xuICAgIGxldCBsb2NhbERhdGE7XG4gICAgaWYgKCFtYW5pZmVzdFZlcnNpb24pIHtcbiAgICAgIHNlcnZlckxhc3RVcGRhdGVkT24gPSBjb250ZW50RGF0YS5sYXN0VXBkYXRlZE9uO1xuICAgICAgc2VydmVyRGF0YSA9IGNvbnRlbnREYXRhO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2NhbERhdGEgPSBjb250ZW50RGF0YTtcbiAgICB9XG5cbiAgICBpZiAoIWNvbnRlbnREYXRhLnByaW1hcnlDYXRlZ29yeSAmJiBjb250ZW50RGF0YS5jb250ZW50VHlwZSAmJiBjb250ZW50RGF0YS5taW1lVHlwZSkge1xuICAgICAgY29udGVudERhdGEucHJpbWFyeUNhdGVnb3J5ID0gQ3NQcmltYXJ5Q2F0ZWdvcnlNYXBwZXIuZ2V0UHJpbWFyeUNhdGVnb3J5KFxuICAgICAgICBjb250ZW50RGF0YS5jb250ZW50VHlwZS50b0xvd2VyQ2FzZSgpLCBjb250ZW50RGF0YS5taW1lVHlwZSwgY29udGVudERhdGEucmVzb3VyY2VUeXBlKTtcbiAgICB9XG5cbiAgICBjb25zdCBwcmltYXJ5Q2F0ZWdvcnkgPSBjb250ZW50RGF0YS5wcmltYXJ5Q2F0ZWdvcnkgPyBjb250ZW50RGF0YS5wcmltYXJ5Q2F0ZWdvcnkgOiBjb250ZW50RGF0YS5jb250ZW50VHlwZTtcbiAgICAgIGlmICghY29udGVudERhdGEudHJhY2thYmxlICYmIHByaW1hcnlDYXRlZ29yeSAmJiBwcmltYXJ5Q2F0ZWdvcnkudG9Mb3dlckNhc2UoKSA9PT0gQ3NDb250ZW50VHlwZS5DT1VSU0UudG9Mb3dlckNhc2UoKSkge1xuICAgICAgICAgIGNvbnRlbnREYXRhLnRyYWNrYWJsZSA9IHtcbiAgICAgICAgICAgIGVuYWJsZWQ6IFRyYWNraW5nRW5hYmxlZC5ZRVNcbiAgICAgICAgICB9O1xuICAgICAgfVxuICAgICAgaWYgKCFjb250ZW50RGF0YS50cmFja2FibGUpIHtcbiAgICAgICAgICBjb250ZW50RGF0YS50cmFja2FibGUgPSB7XG4gICAgICAgICAgICBlbmFibGVkOiBUcmFja2luZ0VuYWJsZWQuTk9cbiAgICAgICAgICB9O1xuICAgICAgfVxuICAgIHJldHVybiB7XG4gICAgICBpZGVudGlmaWVyOiBjb250ZW50RGF0YS5pZGVudGlmaWVyLFxuICAgICAgbmFtZTogY29udGVudERhdGEubmFtZSxcbiAgICAgIGNvbnRlbnREYXRhOiBjb250ZW50RGF0YSxcbiAgICAgIGlzVXBkYXRlQXZhaWxhYmxlOiBDb250ZW50VXRpbC5pc1VwZGF0ZUF2YWlsYWJsZShzZXJ2ZXJEYXRhLCBsb2NhbERhdGEpLFxuICAgICAgbWltZVR5cGU6IGNvbnRlbnREYXRhLm1pbWVUeXBlLFxuICAgICAgYmFzZVBhdGg6ICcnLFxuICAgICAgY29udGVudFR5cGU6IENvbnRlbnRVdGlsLnJlYWRDb250ZW50VHlwZShjb250ZW50RGF0YSksXG4gICAgICBwcmltYXJ5Q2F0ZWdvcnk6IENvbnRlbnRVdGlsLnJlYWRQcmltYXJ5Q2F0ZWdvcnkoY29udGVudERhdGEpLFxuICAgICAgaXNBdmFpbGFibGVMb2NhbGx5OiBmYWxzZSxcbiAgICAgIHJlZmVyZW5jZUNvdW50OiAwLFxuICAgICAgc2l6ZU9uRGV2aWNlOiAwLFxuICAgICAgbGFzdFVzZWRUaW1lOiAwLFxuICAgICAgbGFzdFVwZGF0ZWRUaW1lOiAwLFxuICAgIH07XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIG1hcENvbnRlbnREQkVudHJ5VG9Db250ZW50KGNvbnRlbnRFbnRyeTogQ29udGVudEVudHJ5LlNjaGVtYU1hcCwgc2hvdWxkQ29udmVydEJhc2VQYXRoPzogYm9vbGVhbik6IENvbnRlbnQge1xuICAgIGxldCBjb250ZW50RGF0YTtcbiAgICBjb25zdCBzZXJ2ZXJJbmZvID0gY29udGVudEVudHJ5W0NvbnRlbnRFbnRyeS5DT0xVTU5fTkFNRV9TRVJWRVJfREFUQV07XG4gICAgY29uc3QgbG9jYWxJbmZvID0gY29udGVudEVudHJ5W0NvbnRlbnRFbnRyeS5DT0xVTU5fTkFNRV9MT0NBTF9EQVRBXTtcbiAgICBjb25zdCBzZXJ2ZXJEYXRhOiBDb250ZW50RGF0YSA9IHNlcnZlckluZm8gJiYgSlNPTi5wYXJzZShzZXJ2ZXJJbmZvKTtcbiAgICBsZXQgbG9jYWxEYXRhOiBDb250ZW50RGF0YSA9IGxvY2FsSW5mbyAmJiBKU09OLnBhcnNlKGxvY2FsSW5mbyk7XG5cbiAgICBsZXQgaWRlbnRpZmllciA9IGNvbnRlbnRFbnRyeVtDb250ZW50RW50cnkuQ09MVU1OX05BTUVfSURFTlRJRklFUl07XG4gICAgbGV0IG1pbWVUeXBlID0gY29udGVudEVudHJ5W0NvbnRlbnRFbnRyeS5DT0xVTU5fTkFNRV9NSU1FX1RZUEVdO1xuICAgIGxldCB2aXNpYmlsaXR5ID0gY29udGVudEVudHJ5W0NvbnRlbnRFbnRyeS5DT0xVTU5fTkFNRV9WSVNJQklMSVRZXTtcbiAgICBsZXQgY29udGVudFR5cGUgPSBjb250ZW50RW50cnlbQ29udGVudEVudHJ5LkNPTFVNTl9OQU1FX0NPTlRFTlRfVFlQRV07XG4gICAgbGV0IHByaW1hcnlDYXRlZ29yeSA9IGNvbnRlbnRFbnRyeVtDb250ZW50RW50cnkuQ09MVU1OX05BTUVfUFJJTUFSWV9DQVRFR09SWV07XG4gICAgbGV0IGxhc3RVc2VkVGltZSA9IDA7XG4gICAgbGV0IHJlc291cmNlVHlwZTtcbiAgICBpZiAoY29udGVudEVudHJ5Lmhhc093blByb3BlcnR5KENvbnRlbnRBY2Nlc3NFbnRyeS5DT0xVTU5fTkFNRV9FUE9DSF9USU1FU1RBTVApKSB7XG4gICAgICBsYXN0VXNlZFRpbWUgPSBjb250ZW50RW50cnlbQ29udGVudEFjY2Vzc0VudHJ5LkNPTFVNTl9OQU1FX0VQT0NIX1RJTUVTVEFNUF07XG4gICAgfVxuXG4gICAgaWYgKGNvbnRlbnRFbnRyeS5oYXNPd25Qcm9wZXJ0eShDb250ZW50TWFya2VyRW50cnkuQ09MVU1OX05BTUVfREFUQSkpIHtcbiAgICAgIGlmICghbG9jYWxEYXRhKSB7XG4gICAgICAgIGxvY2FsRGF0YSA9IEpTT04ucGFyc2UoY29udGVudEVudHJ5W0NvbnRlbnRNYXJrZXJFbnRyeS5DT0xVTU5fTkFNRV9EQVRBXSk7XG4gICAgICB9XG4gICAgICBpZiAobG9jYWxEYXRhKSB7XG4gICAgICAgIGlkZW50aWZpZXIgPSBsb2NhbERhdGEuaWRlbnRpZmllcjtcbiAgICAgICAgbWltZVR5cGUgPSBsb2NhbERhdGEubWltZVR5cGU7XG4gICAgICAgIHJlc291cmNlVHlwZSA9IGxvY2FsRGF0YS5yZXNvdXJjZVR5cGU7XG4gICAgICAgIHZpc2liaWxpdHkgPSBDb250ZW50VXRpbC5yZWFkVmlzaWJpbGl0eShsb2NhbERhdGEpO1xuICAgICAgICBjb250ZW50VHlwZSA9IENvbnRlbnRVdGlsLnJlYWRDb250ZW50VHlwZShsb2NhbERhdGEpO1xuICAgICAgICBwcmltYXJ5Q2F0ZWdvcnkgPSBDb250ZW50VXRpbC5yZWFkUHJpbWFyeUNhdGVnb3J5KGxvY2FsRGF0YSk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChsb2NhbERhdGEpIHtcbiAgICAgIGNvbnRlbnREYXRhID0gbG9jYWxEYXRhO1xuICAgIH1cblxuICAgIGlmIChzZXJ2ZXJEYXRhKSB7XG5cbiAgICAgIGlmICghbG9jYWxEYXRhIHx8ICFDb250ZW50VXRpbC5pc0F2YWlsYWJsZUxvY2FsbHkoY29udGVudEVudHJ5W0NvbnRlbnRFbnRyeS5DT0xVTU5fTkFNRV9DT05URU5UX1NUQVRFXSEpKSB7XG4gICAgICAgIGNvbnRlbnREYXRhID0gc2VydmVyRGF0YTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmICghbG9jYWxEYXRhLnN0cmVhbWluZ1VybCkge1xuICAgICAgICAgIGxvY2FsRGF0YS5zdHJlYW1pbmdVcmwgPSBzZXJ2ZXJEYXRhLnN0cmVhbWluZ1VybDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghbG9jYWxEYXRhLnByZXZpZXdVcmwpIHtcbiAgICAgICAgICBsb2NhbERhdGEucHJldmlld1VybCA9IHNlcnZlckRhdGEucHJldmlld1VybDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChzZXJ2ZXJEYXRhLm1lX3RvdGFsUmF0aW5nc0NvdW50KSB7XG4gICAgICAgICAgbG9jYWxEYXRhLm1lX3RvdGFsUmF0aW5nc0NvdW50ID0gc2VydmVyRGF0YS5tZV90b3RhbFJhdGluZ3NDb3VudDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChzZXJ2ZXJEYXRhLm1lX2F2ZXJhZ2VSYXRpbmcpIHtcbiAgICAgICAgICBsb2NhbERhdGEubWVfYXZlcmFnZVJhdGluZyA9IHNlcnZlckRhdGEubWVfYXZlcmFnZVJhdGluZztcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghbG9jYWxEYXRhLnNpemUpIHtcbiAgICAgICAgICBsb2NhbERhdGEuc2l6ZSA9IHNlcnZlckRhdGEuc2l6ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChzZXJ2ZXJEYXRhLmxpY2Vuc2VEZXRhaWxzKSB7XG4gICAgICAgICAgbG9jYWxEYXRhLmxpY2Vuc2VEZXRhaWxzID0gc2VydmVyRGF0YS5saWNlbnNlRGV0YWlscztcbiAgICAgICAgfVxuICAgICAgICBpZiAoc2VydmVyRGF0YS5mb3J1bUlkKSB7XG4gICAgICAgICAgbG9jYWxEYXRhLmZvcnVtSWQgPSBzZXJ2ZXJEYXRhLmZvcnVtSWQ7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBsZXQgY29udGVudENyZWF0aW9uVGltZSA9IDA7XG4gICAgY29uc3QgbG9jYWxMYXN0VXBkYXRlZFRpbWUgPSBjb250ZW50RW50cnlbQ29udGVudEVudHJ5LkNPTFVNTl9OQU1FX0xPQ0FMX0xBU1RfVVBEQVRFRF9PTl07XG4gICAgaWYgKGxvY2FsTGFzdFVwZGF0ZWRUaW1lKSB7XG4gICAgICBjb250ZW50Q3JlYXRpb25UaW1lID0gbmV3IERhdGUobG9jYWxMYXN0VXBkYXRlZFRpbWUpLmdldFRpbWUoKTtcbiAgICB9XG5cbiAgICBjb25zdCBzaXplT25EZXZpY2UgPSBOdW1iZXIoY29udGVudEVudHJ5W0NvbnRlbnRFbnRyeS5DT0xVTU5fTkFNRV9TSVpFX09OX0RFVklDRV0pO1xuICAgIGNvbnN0IHNpemUgPSBzaXplT25EZXZpY2UgPyBzaXplT25EZXZpY2UgOiBOdW1iZXIoc2VydmVyRGF0YSA/IHNlcnZlckRhdGEuc2l6ZSA6IDApO1xuICAgIGlmICghY29udGVudERhdGEudHJhY2thYmxlICYmIHByaW1hcnlDYXRlZ29yeSAmJiBwcmltYXJ5Q2F0ZWdvcnkudG9Mb3dlckNhc2UoKSA9PT0gQ3NDb250ZW50VHlwZS5DT1VSU0UudG9Mb3dlckNhc2UoKSkge1xuICAgICAgY29udGVudERhdGEudHJhY2thYmxlID0ge1xuICAgICAgICBlbmFibGVkOiBUcmFja2luZ0VuYWJsZWQuWUVTXG4gICAgICB9O1xuICAgIH1cbiAgICBpZiAoIWNvbnRlbnREYXRhLnRyYWNrYWJsZSkge1xuICAgICAgY29udGVudERhdGEudHJhY2thYmxlID0ge1xuICAgICAgICBlbmFibGVkOiBUcmFja2luZ0VuYWJsZWQuTk9cbiAgICAgIH07XG4gICAgfVxuICAgIHJlc291cmNlVHlwZSA9IGNvbnRlbnREYXRhLnJlc291cmNlVHlwZTtcbiAgICBpZiAoIWNvbnRlbnREYXRhLnByaW1hcnlDYXRlZ29yeSAmJiBjb250ZW50VHlwZSkge1xuICAgICAgY29udGVudERhdGEucHJpbWFyeUNhdGVnb3J5ID0gQ3NQcmltYXJ5Q2F0ZWdvcnlNYXBwZXIuZ2V0UHJpbWFyeUNhdGVnb3J5KFxuICAgICAgICBjb250ZW50VHlwZS50b0xvd2VyQ2FzZSgpLCBtaW1lVHlwZSwgcmVzb3VyY2VUeXBlKTtcbiAgICB9XG4gICAgY29uc3QgYmFzZVBhdGggPSBjb250ZW50RW50cnlbQ29udGVudEVudHJ5LkNPTFVNTl9OQU1FX1BBVEhdISB8fCAnJztcbiAgICBpZiAodHlwZW9mIChjb250ZW50RGF0YS5vcmlnaW5EYXRhKSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIGNvbnRlbnREYXRhLm9yaWdpbkRhdGEgPSBDb250ZW50VXRpbC5nZXRQYXJzZUVycm9yT2JqZWN0KGNvbnRlbnREYXRhLm9yaWdpbkRhdGEpO1xuICAgIH1cbiAgICBpZiAoY29udGVudERhdGEudHJhY2thYmxlICYmIHR5cGVvZiAoY29udGVudERhdGEudHJhY2thYmxlKSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIGNvbnRlbnREYXRhLnRyYWNrYWJsZSA9IEpTT04ucGFyc2UoY29udGVudERhdGEudHJhY2thYmxlKTtcbiAgICB9XG4gICAgcmV0dXJuIHtcbiAgICAgIGlkZW50aWZpZXI6IGlkZW50aWZpZXIsXG4gICAgICBuYW1lOiBjb250ZW50RGF0YS5uYW1lLFxuICAgICAgY29udGVudERhdGE6IGNvbnRlbnREYXRhLFxuICAgICAgaXNVcGRhdGVBdmFpbGFibGU6IENvbnRlbnRVdGlsLmlzVXBkYXRlQXZhaWxhYmxlKHNlcnZlckRhdGEsIGxvY2FsRGF0YSksXG4gICAgICBtaW1lVHlwZTogbWltZVR5cGUsXG4gICAgICBiYXNlUGF0aDogIXNob3VsZENvbnZlcnRCYXNlUGF0aCA/IGJhc2VQYXRoIDogJy9fYXBwX2ZpbGVfJyArIGJhc2VQYXRoLFxuICAgICAgcHJpbWFyeUNhdGVnb3J5OiBwcmltYXJ5Q2F0ZWdvcnksXG4gICAgICBjb250ZW50VHlwZTogY29udGVudFR5cGUsXG4gICAgICBpc0F2YWlsYWJsZUxvY2FsbHk6IENvbnRlbnRVdGlsLmlzQXZhaWxhYmxlTG9jYWxseShjb250ZW50RW50cnlbQ29udGVudEVudHJ5LkNPTFVNTl9OQU1FX0NPTlRFTlRfU1RBVEVdISksXG4gICAgICByZWZlcmVuY2VDb3VudDogTnVtYmVyKGNvbnRlbnRFbnRyeVtDb250ZW50RW50cnkuQ09MVU1OX05BTUVfUkVGX0NPVU5UXSkgfHwgMCxcbiAgICAgIHNpemVPbkRldmljZTogc2l6ZSxcbiAgICAgIGxhc3RVc2VkVGltZTogbGFzdFVzZWRUaW1lIHx8IDAsXG4gICAgICBsYXN0VXBkYXRlZFRpbWU6IGNvbnRlbnRDcmVhdGlvblRpbWUsXG4gICAgfTtcbiAgfVxufVxuIl19