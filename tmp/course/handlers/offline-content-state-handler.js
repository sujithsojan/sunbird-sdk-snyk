var __spreadArrays = (this && this.__spreadArrays) || function () {
    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;
    for (var r = Array(s), k = 0, i = 0; i < il; i++)
        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)
            r[k] = a[j];
    return r;
};
import { CourseServiceImpl } from '..';
import { of } from 'rxjs';
import { ArrayUtil } from '../../util/array-util';
import { map, mergeMap } from 'rxjs/operators';
var OfflineContentStateHandler = /** @class */ (function () {
    function OfflineContentStateHandler(keyValueStore) {
        this.keyValueStore = keyValueStore;
    }
    OfflineContentStateHandler.prototype.getLocalContentStateResponse = function (request) {
        var key = CourseServiceImpl.GET_CONTENT_STATE_KEY_PREFIX.concat(request.userId, request.courseId);
        return this.keyValueStore.getValue(key)
            .pipe(map(function (value) {
            var responseContentState = { contentList: [] };
            if (value) {
                var response = JSON.parse(value);
                var result = response['result'];
                if (result && result.hasOwnProperty('contentList')) {
                    responseContentState.contentList = result['contentList'];
                    return responseContentState;
                }
                else {
                    responseContentState.contentList = response['contentList'];
                    return responseContentState;
                }
            }
            responseContentState.contentList = responseContentState.contentList.map(function (contentState) {
                if (typeof contentState.score === 'string') {
                    contentState.score = undefined;
                }
                return contentState;
            });
            return responseContentState;
        }));
    };
    OfflineContentStateHandler.prototype.manipulateEnrolledCoursesResponseLocally = function (updateContentStateRequest) {
        var _this = this;
        var key = CourseServiceImpl.GET_ENROLLED_COURSE_KEY_PREFIX.concat(updateContentStateRequest.userId);
        return this.keyValueStore.getValue(key)
            .pipe(mergeMap(function (value) {
            if (value) {
                var response = JSON.parse(value);
                var result = response['result'];
                var courses = void 0;
                if (result && result.hasOwnProperty('courses')) {
                    courses = result['courses'];
                }
                else {
                    courses = response['courses'];
                }
                if (courses && courses.length) {
                    var newCourses_1 = __spreadArrays(courses);
                    courses.forEach(function (course) {
                        if (course.courseId === updateContentStateRequest.courseId &&
                            course.batchId === updateContentStateRequest.batchId) {
                            if (!course.contentsPlayedOffline || !course.contentsPlayedOffline.length) {
                                course.contentsPlayedOffline = [];
                            }
                            if (updateContentStateRequest.status !== 1 && (course.contentsPlayedOffline.length === 0 ||
                                (course.contentsPlayedOffline.length > 0 &&
                                    !ArrayUtil.contains(course.contentsPlayedOffline, updateContentStateRequest.contentId)))) {
                                course.progress = course.progress ? course.progress : 0;
                                course.progress = course.progress + 1;
                                course.completionPercentage =
                                    _this.getCourseCompletionPercentage(course.leafNodesCount, course.progress);
                                var updatedCourse = course;
                                var playedOffline = updatedCourse.contentsPlayedOffline;
                                if (!playedOffline) {
                                    playedOffline = [];
                                }
                                playedOffline.push(updateContentStateRequest.contentId);
                                updatedCourse.contentsPlayedOffline = playedOffline;
                                updatedCourse.progress = course.progress;
                                updatedCourse.completionPercentage = course.completionPercentage;
                                var toUpdateIndex = newCourses_1.findIndex(function (el) {
                                    return el.contentId === course.contentId || el.batchId === course.batchId;
                                });
                                newCourses_1.splice(toUpdateIndex, 1, updatedCourse);
                            }
                        }
                    });
                    if (newCourses_1 && newCourses_1.length) {
                        if (result && result.hasOwnProperty('courses')) {
                            result['courses'] = newCourses_1;
                        }
                        else {
                            response['courses'] = newCourses_1;
                        }
                        return _this.keyValueStore.setValue(key, JSON.stringify(response));
                    }
                    else {
                        return of(false);
                    }
                }
                else {
                    return of(false);
                }
            }
            else {
                return of(false);
            }
        }));
    };
    OfflineContentStateHandler.prototype.manipulateGetContentStateResponseLocally = function (updateContentStateRequest) {
        var _this = this;
        var key = CourseServiceImpl.GET_CONTENT_STATE_KEY_PREFIX.concat(updateContentStateRequest.userId, updateContentStateRequest.courseId);
        return this.keyValueStore.getValue(key)
            .pipe(mergeMap(function (value) {
            if (value) {
                var contentStateResponse = { contentList: [] };
                var response = JSON.parse(value);
                var result = response['result'];
                if (result && result.hasOwnProperty('contentList')) {
                    contentStateResponse.contentList = result['contentList'];
                }
                else {
                    contentStateResponse.contentList = response['contentList'];
                }
                if (contentStateResponse) {
                    var contentStateList_1 = contentStateResponse.contentList;
                    var newContentState_1;
                    if (!contentStateList_1 || !contentStateList_1.length) {
                        newContentState_1 = _this.getContentState(updateContentStateRequest);
                        contentStateList_1 = [];
                        contentStateList_1.push(newContentState_1);
                        contentStateResponse.contentList = contentStateList_1;
                        return _this.keyValueStore.setValue(key, JSON.stringify(contentStateResponse));
                    }
                    else {
                        contentStateList_1.forEach(function (contentState) {
                            if (contentState.contentId === updateContentStateRequest.contentId) {
                                if (contentState.status !== updateContentStateRequest.status) {
                                    updateContentStateRequest.score = contentState.score;
                                    updateContentStateRequest.bestScore = contentState.bestScore;
                                    newContentState_1 = _this.getContentState(updateContentStateRequest);
                                    contentStateList_1 = contentStateList_1.filter(function (el) {
                                        return el.contentId !== contentState.contentId;
                                    });
                                }
                            }
                            else {
                                newContentState_1 = _this.getContentState(updateContentStateRequest);
                            }
                        });
                        if (newContentState_1) {
                            contentStateList_1.push(newContentState_1);
                            contentStateResponse.contentList = contentStateList_1;
                            return _this.keyValueStore.setValue(key, JSON.stringify(contentStateResponse));
                        }
                        else {
                            return of(false);
                        }
                    }
                }
                else {
                    return of(false);
                }
            }
            else {
                return of(false);
            }
        }));
    };
    OfflineContentStateHandler.prototype.getCourseCompletionPercentage = function (leafNodeCount, progress) {
        if (leafNodeCount === 0 || leafNodeCount === undefined) {
            return 0;
        }
        var completionData = ((progress / leafNodeCount) * 100);
        if (isNaN(completionData)) {
            return 0;
        }
        else if (completionData > 100) {
            return 100;
        }
        else {
            return Math.floor(completionData);
        }
    };
    OfflineContentStateHandler.prototype.getContentState = function (updateContentStateRequest) {
        return {
            id: updateContentStateRequest.userId,
            userId: updateContentStateRequest.userId,
            courseId: updateContentStateRequest.courseId,
            contentId: updateContentStateRequest.contentId,
            batchId: updateContentStateRequest.batchId,
            result: updateContentStateRequest.result,
            grade: updateContentStateRequest.grade,
            score: updateContentStateRequest.score,
            bestScore: updateContentStateRequest.bestScore,
            status: updateContentStateRequest.status,
            progress: updateContentStateRequest.progress,
        };
    };
    return OfflineContentStateHandler;
}());
export { OfflineContentStateHandler };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2ZmbGluZS1jb250ZW50LXN0YXRlLWhhbmRsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY291cnNlL2hhbmRsZXJzL29mZmxpbmUtY29udGVudC1zdGF0ZS1oYW5kbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFDQSxPQUFPLEVBQTZDLGlCQUFpQixFQUFvRCxNQUFNLElBQUksQ0FBQztBQUNwSSxPQUFPLEVBQWEsRUFBRSxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBQ3BDLE9BQU8sRUFBQyxTQUFTLEVBQUMsTUFBTSx1QkFBdUIsQ0FBQztBQUNoRCxPQUFPLEVBQUMsR0FBRyxFQUFFLFFBQVEsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBRTdDO0lBRUksb0NBQW9CLGFBQTRCO1FBQTVCLGtCQUFhLEdBQWIsYUFBYSxDQUFlO0lBRWhELENBQUM7SUFFTSxpRUFBNEIsR0FBbkMsVUFBb0MsT0FBK0I7UUFDL0QsSUFBTSxHQUFHLEdBQUcsaUJBQWlCLENBQUMsNEJBQTRCLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3BHLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDO2FBQ2xDLElBQUksQ0FDRCxHQUFHLENBQUMsVUFBQyxLQUF5QjtZQUMxQixJQUFNLG9CQUFvQixHQUF5QixFQUFDLFdBQVcsRUFBRSxFQUFFLEVBQUMsQ0FBQztZQUNyRSxJQUFJLEtBQUssRUFBRTtnQkFDUCxJQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUNuQyxJQUFNLE1BQU0sR0FBRyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQ2xDLElBQUksTUFBTSxJQUFJLE1BQU0sQ0FBQyxjQUFjLENBQUMsYUFBYSxDQUFDLEVBQUU7b0JBQ2hELG9CQUFvQixDQUFDLFdBQVcsR0FB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QUFNO1lBQ3hDLEtBQUssRUFBRSx5QkFBeUIsQ0FBQyxLQUFLO1lBQ3RDLEtBQUssRUFBRSx5QkFBeUIsQ0FBQyxLQUFLO1lBQ3RDLFNBQVMsRUFBRSx5QkFBeUIsQ0FBQyxTQUFTO1lBQzlDLE1BQU0sRUFBRSx5QkFBeUIsQ0FBQyxNQUFNO1lBQ3hDLFFBQVEsRUFBRSx5QkFBeUIsQ0FBQyxRQUFRO1NBQy9DLENBQUM7SUFDTixDQUFDO0lBQ0wsaUNBQUM7QUFBRCxDQUFDLEFBbk1ELElBbU1DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtLZXlWYWx1ZVN0b3JlfSBmcm9tICcuLi8uLi9rZXktdmFsdWUtc3RvcmUnO1xuaW1wb3J0IHtDb250ZW50U3RhdGUsIENvbnRlbnRTdGF0ZVJlc3BvbnNlLCBDb3Vyc2UsIENvdXJzZVNlcnZpY2VJbXBsLCBHZXRDb250ZW50U3RhdGVSZXF1ZXN0LCBVcGRhdGVDb250ZW50U3RhdGVSZXF1ZXN0fSBmcm9tICcuLic7XG5pbXBvcnQge09ic2VydmFibGUsIG9mfSBmcm9tICdyeGpzJztcbmltcG9ydCB7QXJyYXlVdGlsfSBmcm9tICcuLi8uLi91dGlsL2FycmF5LXV0aWwnO1xuaW1wb3J0IHttYXAsIG1lcmdlTWFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmV4cG9ydCBjbGFzcyBPZmZsaW5lQ29udGVudFN0YXRlSGFuZGxlciB7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGtleVZhbHVlU3RvcmU6IEtleVZhbHVlU3RvcmUpIHtcblxuICAgIH1cblxuICAgIHB1YmxpYyBnZXRMb2NhbENvbnRlbnRTdGF0ZVJlc3BvbnNlKHJlcXVlc3Q6IEdldENvbnRlbnRTdGF0ZVJlcXVlc3QpOiBPYnNlcnZhYmxlPENvbnRlbnRTdGF0ZVJlc3BvbnNlPiB7XG4gICAgICAgIGNvbnN0IGtleSA9IENvdXJzZVNlcnZpY2VJbXBsLkdFVF9DT05URU5UX1NUQVRFX0tFWV9QUkVGSVguY29uY2F0KHJlcXVlc3QudXNlcklkLCByZXF1ZXN0LmNvdXJzZUlkKTtcbiAgICAgICAgcmV0dXJuIHRoaXMua2V5VmFsdWVTdG9yZS5nZXRWYWx1ZShrZXkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKHZhbHVlOiBzdHJpbmcgfCB1bmRlZmluZWQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzcG9uc2VDb250ZW50U3RhdGU6IENvbnRlbnRTdGF0ZVJlc3BvbnNlID0ge2NvbnRlbnRMaXN0OiBbXX07XG4gICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBKU09OLnBhcnNlKHZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHJlc3BvbnNlWydyZXN1bHQnXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQgJiYgcmVzdWx0Lmhhc093blByb3BlcnR5KCdjb250ZW50TGlzdCcpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VDb250ZW50U3RhdGUuY29udGVudExpc3QgPSByZXN1bHRbJ2NvbnRlbnRMaXN0J107XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlQ29udGVudFN0YXRlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZUNvbnRlbnRTdGF0ZS5jb250ZW50TGlzdCA9IHJlc3BvbnNlWydjb250ZW50TGlzdCddO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZUNvbnRlbnRTdGF0ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXNwb25zZUNvbnRlbnRTdGF0ZS5jb250ZW50TGlzdCA9IHJlc3BvbnNlQ29udGVudFN0YXRlLmNvbnRlbnRMaXN0Lm1hcCgoY29udGVudFN0YXRlOiBDb250ZW50U3RhdGUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgodHlwZW9mIGNvbnRlbnRTdGF0ZS5zY29yZSBhcyBhbnkpID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnRTdGF0ZS5zY29yZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjb250ZW50U3RhdGU7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2VDb250ZW50U3RhdGU7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICk7XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgbWFuaXB1bGF0ZUVucm9sbGVkQ291cnNlc1Jlc3BvbnNlTG9jYWxseSh1cGRhdGVDb250ZW50U3RhdGVSZXF1ZXN0OiBVcGRhdGVDb250ZW50U3RhdGVSZXF1ZXN0KTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgICAgIGNvbnN0IGtleSA9IENvdXJzZVNlcnZpY2VJbXBsLkdFVF9FTlJPTExFRF9DT1VSU0VfS0VZX1BSRUZJWC5jb25jYXQodXBkYXRlQ29udGVudFN0YXRlUmVxdWVzdC51c2VySWQpO1xuICAgICAgICByZXR1cm4gdGhpcy5rZXlWYWx1ZVN0b3JlLmdldFZhbHVlKGtleSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1lcmdlTWFwKCh2YWx1ZTogc3RyaW5nIHwgdW5kZWZpbmVkKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBKU09OLnBhcnNlKHZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHJlc3BvbnNlWydyZXN1bHQnXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBjb3Vyc2VzOiBDb3Vyc2VbXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQgJiYgcmVzdWx0Lmhhc093blByb3BlcnR5KCdjb3Vyc2VzJykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb3Vyc2VzID0gcmVzdWx0Wydjb3Vyc2VzJ107XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvdXJzZXMgPSByZXNwb25zZVsnY291cnNlcyddO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvdXJzZXMgJiYgY291cnNlcy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXdDb3Vyc2VzOiBDb3Vyc2VbXSA9IFsuLi5jb3Vyc2VzXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb3Vyc2VzLmZvckVhY2goKGNvdXJzZTogQ291cnNlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb3Vyc2UuY291cnNlSWQgPT09IHVwZGF0ZUNvbnRlbnRTdGF0ZVJlcXVlc3QuY291cnNlSWQgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvdXJzZS5iYXRjaElkID09PSB1cGRhdGVDb250ZW50U3RhdGVSZXF1ZXN0LmJhdGNoSWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghY291cnNlLmNvbnRlbnRzUGxheWVkT2ZmbGluZSB8fCAhY291cnNlLmNvbnRlbnRzUGxheWVkT2ZmbGluZSEubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY291cnNlLmNvbnRlbnRzUGxheWVkT2ZmbGluZSA9IFtdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVwZGF0ZUNvbnRlbnRTdGF0ZVJlcXVlc3Quc3RhdHVzICE9PSAxICYmIChjb3Vyc2UuY29udGVudHNQbGF5ZWRPZmZsaW5lIS5sZW5ndGggPT09IDAgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoY291cnNlLmNvbnRlbnRzUGxheWVkT2ZmbGluZSEubGVuZ3RoID4gMCAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAhQXJyYXlVdGlsLmNvbnRhaW5zKGNvdXJzZS5jb250ZW50c1BsYXllZE9mZmxpbmUsIHVwZGF0ZUNvbnRlbnRTdGF0ZVJlcXVlc3QuY29udGVudElkKSkpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY291cnNlLnByb2dyZXNzID0gY291cnNlLnByb2dyZXNzID8gY291cnNlLnByb2dyZXNzIDogMDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb3Vyc2UucHJvZ3Jlc3MgPSBjb3Vyc2UucHJvZ3Jlc3MgKyAxO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvdXJzZS5jb21wbGV0aW9uUGVyY2VudGFnZSA9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0Q291cnNlQ29tcGxldGlvblBlcmNlbnRhZ2UoY291cnNlLmxlYWZOb2Rlc0NvdW50LCBjb3Vyc2UucHJvZ3Jlc3MpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHVwZGF0ZWRDb3Vyc2U6IENvdXJzZSA9IGNvdXJzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcGxheWVkT2ZmbGluZTogc3RyaW5nW10gPSB1cGRhdGVkQ291cnNlLmNvbnRlbnRzUGxheWVkT2ZmbGluZSE7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFwbGF5ZWRPZmZsaW5lKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBsYXllZE9mZmxpbmUgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGxheWVkT2ZmbGluZS5wdXNoKHVwZGF0ZUNvbnRlbnRTdGF0ZVJlcXVlc3QuY29udGVudElkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVkQ291cnNlLmNvbnRlbnRzUGxheWVkT2ZmbGluZSA9IHBsYXllZE9mZmxpbmU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlZENvdXJzZS5wcm9ncmVzcyA9IGNvdXJzZS5wcm9ncmVzcztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVkQ291cnNlLmNvbXBsZXRpb25QZXJjZW50YWdlID0gY291cnNlLmNvbXBsZXRpb25QZXJjZW50YWdlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvVXBkYXRlSW5kZXggPSBuZXdDb3Vyc2VzLmZpbmRJbmRleCgoZWw6IENvdXJzZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWwuY29udGVudElkID09PSBjb3Vyc2UuY29udGVudElkIHx8IGVsLmJhdGNoSWQgPT09IGNvdXJzZS5iYXRjaElkO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0NvdXJzZXMuc3BsaWNlKHRvVXBkYXRlSW5kZXgsIDEsIHVwZGF0ZWRDb3Vyc2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5ld0NvdXJzZXMgJiYgbmV3Q291cnNlcy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdCAmJiByZXN1bHQuaGFzT3duUHJvcGVydHkoJ2NvdXJzZXMnKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0Wydjb3Vyc2VzJ10gPSBuZXdDb3Vyc2VzO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VbJ2NvdXJzZXMnXSA9IG5ld0NvdXJzZXM7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMua2V5VmFsdWVTdG9yZS5zZXRWYWx1ZShrZXksIEpTT04uc3RyaW5naWZ5KHJlc3BvbnNlKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9mKGZhbHNlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9mKGZhbHNlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvZihmYWxzZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIHB1YmxpYyBtYW5pcHVsYXRlR2V0Q29udGVudFN0YXRlUmVzcG9uc2VMb2NhbGx5KHVwZGF0ZUNvbnRlbnRTdGF0ZVJlcXVlc3Q6IFVwZGF0ZUNvbnRlbnRTdGF0ZVJlcXVlc3QpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICAgICAgY29uc3Qga2V5ID0gQ291cnNlU2VydmljZUltcGwuR0VUX0NPTlRFTlRfU1RBVEVfS0VZX1BSRUZJWC5jb25jYXQodXBkYXRlQ29udGVudFN0YXRlUmVxdWVzdC51c2VySWQsXG4gICAgICAgICAgICB1cGRhdGVDb250ZW50U3RhdGVSZXF1ZXN0LmNvdXJzZUlkKTtcbiAgICAgICAgcmV0dXJuIHRoaXMua2V5VmFsdWVTdG9yZS5nZXRWYWx1ZShrZXkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtZXJnZU1hcCgodmFsdWU6IHN0cmluZyB8IHVuZGVmaW5lZCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbnRlbnRTdGF0ZVJlc3BvbnNlOiBDb250ZW50U3RhdGVSZXNwb25zZSA9IHtjb250ZW50TGlzdDogW119O1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBKU09OLnBhcnNlKHZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHJlc3BvbnNlWydyZXN1bHQnXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQgJiYgcmVzdWx0Lmhhc093blByb3BlcnR5KCdjb250ZW50TGlzdCcpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudFN0YXRlUmVzcG9uc2UuY29udGVudExpc3QgPSByZXN1bHRbJ2NvbnRlbnRMaXN0J107XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnRTdGF0ZVJlc3BvbnNlLmNvbnRlbnRMaXN0ID0gcmVzcG9uc2VbJ2NvbnRlbnRMaXN0J107XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29udGVudFN0YXRlUmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgY29udGVudFN0YXRlTGlzdDogQ29udGVudFN0YXRlW10gPSBjb250ZW50U3RhdGVSZXNwb25zZS5jb250ZW50TGlzdDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgbmV3Q29udGVudFN0YXRlOiBDb250ZW50U3RhdGU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFjb250ZW50U3RhdGVMaXN0IHx8ICFjb250ZW50U3RhdGVMaXN0Lmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdDb250ZW50U3RhdGUgPSB0aGlzLmdldENvbnRlbnRTdGF0ZSh1cGRhdGVDb250ZW50U3RhdGVSZXF1ZXN0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudFN0YXRlTGlzdCA9IFtdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50U3RhdGVMaXN0LnB1c2gobmV3Q29udGVudFN0YXRlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudFN0YXRlUmVzcG9uc2UuY29udGVudExpc3QgPSBjb250ZW50U3RhdGVMaXN0O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5rZXlWYWx1ZVN0b3JlLnNldFZhbHVlKGtleSwgSlNPTi5zdHJpbmdpZnkoY29udGVudFN0YXRlUmVzcG9uc2UpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50U3RhdGVMaXN0LmZvckVhY2goKGNvbnRlbnRTdGF0ZTogQ29udGVudFN0YXRlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29udGVudFN0YXRlLmNvbnRlbnRJZCA9PT0gdXBkYXRlQ29udGVudFN0YXRlUmVxdWVzdC5jb250ZW50SWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29udGVudFN0YXRlLnN0YXR1cyAhPT0gdXBkYXRlQ29udGVudFN0YXRlUmVxdWVzdC5zdGF0dXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlQ29udGVudFN0YXRlUmVxdWVzdC5zY29yZSA9IGNvbnRlbnRTdGF0ZS5zY29yZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlQ29udGVudFN0YXRlUmVxdWVzdC5iZXN0U2NvcmUgPSBjb250ZW50U3RhdGUuYmVzdFNjb3JlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdDb250ZW50U3RhdGUgPSB0aGlzLmdldENvbnRlbnRTdGF0ZSh1cGRhdGVDb250ZW50U3RhdGVSZXF1ZXN0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudFN0YXRlTGlzdCA9IGNvbnRlbnRTdGF0ZUxpc3QuZmlsdGVyKChlbDogQ29udGVudFN0YXRlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWwuY29udGVudElkICE9PSBjb250ZW50U3RhdGUuY29udGVudElkO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0NvbnRlbnRTdGF0ZSA9IHRoaXMuZ2V0Q29udGVudFN0YXRlKHVwZGF0ZUNvbnRlbnRTdGF0ZVJlcXVlc3QpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV3Q29udGVudFN0YXRlISkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudFN0YXRlTGlzdC5wdXNoKG5ld0NvbnRlbnRTdGF0ZSEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudFN0YXRlUmVzcG9uc2UuY29udGVudExpc3QgPSBjb250ZW50U3RhdGVMaXN0O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMua2V5VmFsdWVTdG9yZS5zZXRWYWx1ZShrZXksIEpTT04uc3RyaW5naWZ5KGNvbnRlbnRTdGF0ZVJlc3BvbnNlKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2YoZmFsc2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2YoZmFsc2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2YoZmFsc2UpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0Q291cnNlQ29tcGxldGlvblBlcmNlbnRhZ2UobGVhZk5vZGVDb3VudDogbnVtYmVyIHwgdW5kZWZpbmVkLCBwcm9ncmVzczogbnVtYmVyKSB7XG4gICAgICAgIGlmIChsZWFmTm9kZUNvdW50ID09PSAwIHx8IGxlYWZOb2RlQ291bnQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgY29tcGxldGlvbkRhdGEgPSAoKHByb2dyZXNzIC8gbGVhZk5vZGVDb3VudCkgKiAxMDApO1xuXG4gICAgICAgIGlmIChpc05hTihjb21wbGV0aW9uRGF0YSkpIHtcbiAgICAgICAgICAgIHJldHVybiAwO1xuICAgICAgICB9IGVsc2UgaWYgKGNvbXBsZXRpb25EYXRhID4gMTAwKSB7XG4gICAgICAgICAgICByZXR1cm4gMTAwO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IoY29tcGxldGlvbkRhdGEpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRDb250ZW50U3RhdGUodXBkYXRlQ29udGVudFN0YXRlUmVxdWVzdDogVXBkYXRlQ29udGVudFN0YXRlUmVxdWVzdCk6IENvbnRlbnRTdGF0ZSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBpZDogdXBkYXRlQ29udGVudFN0YXRlUmVxdWVzdC51c2VySWQsXG4gICAgICAgICAgICB1c2VySWQ6IHVwZGF0ZUNvbnRlbnRTdGF0ZVJlcXVlc3QudXNlcklkLFxuICAgICAgICAgICAgY291cnNlSWQ6IHVwZGF0ZUNvbnRlbnRTdGF0ZVJlcXVlc3QuY291cnNlSWQsXG4gICAgICAgICAgICBjb250ZW50SWQ6IHVwZGF0ZUNvbnRlbnRTdGF0ZVJlcXVlc3QuY29udGVudElkLFxuICAgICAgICAgICAgYmF0Y2hJZDogdXBkYXRlQ29udGVudFN0YXRlUmVxdWVzdC5iYXRjaElkLFxuICAgICAgICAgICAgcmVzdWx0OiB1cGRhdGVDb250ZW50U3RhdGVSZXF1ZXN0LnJlc3VsdCxcbiAgICAgICAgICAgIGdyYWRlOiB1cGRhdGVDb250ZW50U3RhdGVSZXF1ZXN0LmdyYWRlLFxuICAgICAgICAgICAgc2NvcmU6IHVwZGF0ZUNvbnRlbnRTdGF0ZVJlcXVlc3Quc2NvcmUsXG4gICAgICAgICAgICBiZXN0U2NvcmU6IHVwZGF0ZUNvbnRlbnRTdGF0ZVJlcXVlc3QuYmVzdFNjb3JlLFxuICAgICAgICAgICAgc3RhdHVzOiB1cGRhdGVDb250ZW50U3RhdGVSZXF1ZXN0LnN0YXR1cyxcbiAgICAgICAgICAgIHByb2dyZXNzOiB1cGRhdGVDb250ZW50U3RhdGVSZXF1ZXN0LnByb2dyZXNzLFxuICAgICAgICB9O1xuICAgIH1cbn1cbiJdfQ==