import { of } from 'rxjs';
import { ContentUtil } from '../../content/util/content-util';
import { map, mergeMap } from 'rxjs/operators';
var OfflineCourseCacheHandler = /** @class */ (function () {
    function OfflineCourseCacheHandler(dbService, contentService, keyValueStore) {
        this.dbService = dbService;
        this.contentService = contentService;
        this.keyValueStore = keyValueStore;
    }
    OfflineCourseCacheHandler.prototype.addNewlyEnrolledCourseToGetEnrolledCourses = function (enrollCourseRequest) {
        var _this = this;
        var key = OfflineCourseCacheHandler.GET_ENROLLED_COURSES_KEY_PREFIX.concat(enrollCourseRequest.userId);
        return this.keyValueStore.getValue(key)
            .pipe(mergeMap(function (enrolledCoursesInDB) {
            if (!enrolledCoursesInDB) {
                return _this.getNewlyAddedCourse(enrollCourseRequest)
                    .pipe(map(function (course) {
                    var courseList = [];
                    courseList.push(course);
                    return courseList;
                }), mergeMap(function (list) {
                    return _this.keyValueStore.setValue(key, JSON.stringify(list));
                }));
            }
            else {
                var response_1 = JSON.parse(enrolledCoursesInDB);
                var result_1 = response_1['result'];
                var courses_1;
                if (result_1 && result_1.hasOwnProperty('courses')) {
                    courses_1 = result_1['courses'];
                }
                else {
                    courses_1 = response_1['courses'];
                }
                var isCourseAvailable_1 = false;
                courses_1.forEach(function (course) {
                    if (course.courseId === enrollCourseRequest.courseId) {
                        isCourseAvailable_1 = true;
                    }
                });
                if (!isCourseAvailable_1) {
                    return _this.getNewlyAddedCourse(enrollCourseRequest)
                        .pipe(map(function (newCourse) {
                        courses_1.push(newCourse);
                        if (result_1 && result_1.hasOwnProperty('courses')) {
                            result_1['courses'] = courses_1;
                        }
                        else {
                            response_1['courses'] = courses_1;
                        }
                        return JSON.stringify(response_1);
                    }), mergeMap(function (value) {
                        return _this.keyValueStore.setValue(key, value);
                    }));
                }
                else {
                    return of(true);
                }
            }
        }));
    };
    OfflineCourseCacheHandler.prototype.getNewlyAddedCourse = function (enrollCourseRequest) {
        var _this = this;
        return this.contentService.getChildContents({
            contentId: enrollCourseRequest.courseId,
            hierarchyInfo: []
        })
            .pipe(map(function (result) {
            return _this.getLeafNodeCount(result);
        }), mergeMap(function (leafNodeCount) {
            return _this.contentService.getContentDetails({ contentId: enrollCourseRequest.courseId })
                .pipe(mergeMap(function (content) {
                var course = {};
                course.progress = 0;
                course.userId = enrollCourseRequest.userId;
                course.batchId = enrollCourseRequest.batchId;
                course.courseId = enrollCourseRequest.courseId;
                course.contentId = enrollCourseRequest.courseId;
                course.leafNodesCount = leafNodeCount;
                var batch = {};
                batch['identifier'] = enrollCourseRequest.batchId;
                batch['status'] = enrollCourseRequest.batchStatus;
                course.batch = batch;
                if (content) {
                    course.courseName = content.contentData.name;
                    if (content.contentData.appIcon.startsWith('https://')) {
                        course.courseLogoUrl = content.contentData.appIcon;
                    }
                    else {
                        course.courseLogoUrl = ContentUtil
                            .getBasePath(content.basePath.concat('/', content.contentData.appIcon));
                    }
                }
                return of(course);
            }));
        }));
    };
    OfflineCourseCacheHandler.prototype.getLeafNodeCount = function (obj) {
        var _this = this;
        if (!obj.children || !obj.children.length) {
            return 1;
        }
        return obj.children.reduce(function (acc, child) {
            acc += _this.getLeafNodeCount(child);
            return acc;
        }, 0);
    };
    OfflineCourseCacheHandler.GET_ENROLLED_COURSES_KEY_PREFIX = 'enrolledCourses';
    return OfflineCourseCacheHandler;
}());
export { OfflineCourseCacheHandler };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2ZmbGluZS1jb3Vyc2UtY2FjaGUtaGFuZGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb3Vyc2UvaGFuZGxlcnMvb2ZmbGluZS1jb3Vyc2UtY2FjaGUtaGFuZGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFHQSxPQUFPLEVBQWEsRUFBRSxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBRXBDLE9BQU8sRUFBQyxXQUFXLEVBQUMsTUFBTSxpQ0FBaUMsQ0FBQztBQUM1RCxPQUFPLEVBQUMsR0FBRyxFQUFFLFFBQVEsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBRTdDO0lBR0ksbUNBQW9CLFNBQW9CLEVBQ3BCLGNBQThCLEVBQzlCLGFBQTRCO1FBRjVCLGNBQVMsR0FBVCxTQUFTLENBQVc7UUFDcEIsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBQzlCLGtCQUFhLEdBQWIsYUFBYSxDQUFlO0lBRWhELENBQUM7SUFFTSw4RUFBMEMsR0FBakQsVUFBa0QsbUJBQXdDO1FBQTFGLGlCQXNEQztRQXJERyxJQUFNLEdBQUcsR0FBRyx5QkFBeUIsQ0FBQywrQkFBK0IsQ0FBQyxNQUFNLENBQUMsbUJBQW1CLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDekcsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUM7YUFDbEMsSUFBSSxDQUNELFFBQVEsQ0FBQyxVQUFDLG1CQUF1QztZQUM3QyxJQUFJLENBQUMsbUJBQW1CLEVBQUU7Z0JBQ3RCLE9BQU8sS0FBSSxDQUFDLG1CQUFtQixDQUFDLG1CQUFtQixDQUFDO3FCQUMvQyxJQUFJLENBQ0QsR0FBRyxDQUFDLFVBQUMsTUFBYztvQkFDZixJQUFNLFVBQVUsR0FBYSxFQUFFLENBQUM7b0JBQ2hDLFVBQVUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7b0JBQ3hCLE9BQU8sVUFBVSxDQUFDO2dCQUN0QixDQUFDLENBQUMsRUFDRixRQUFRLENBQUMsVUFBQyxJQUFjO29CQUNwQixPQUFPLEtBQUksQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7Z0JBQ2xFLENBQUMsQ0FBQyxDQUNMLENBQUM7YUFDVDtpQkFBTTtnQkFDSCxJQUFNLFVBQVEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLG1CQUFtQixDQUFDLENBQUM7Z0JBQ2pELElBQU0sUUFBTSxHQUFHLFVBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDbEMsSUFBSSxTQUFpQixDQUFDO2dCQUN0QixJQUFJLFFBQU0sSUFBSSxRQUFNLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxFQUFFO29CQUM1QyxTQUFPLEdBQUcsUUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2lCQUMvQjtxQkFBTTtvQkFDSCxTQUFPLEdBQUcsVUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2lCQUNqQztnQkFDRCxJQUFJLG1CQUFpQixHQUFHLEtBQUssQ0FBQztnQkFDOUIsU0FBTyxDQUFDLE9BQU8sQ0FBQyxVQUFDLE1BQWM7b0JBQzNCLElBQUksTUFBTSxDQUFDLFFBQVEsS0FBSyxtQkFBbUIsQ0FBQyxRQUFRLEVBQUU7d0JBQ2xELG1CQUFpQixHQUFHLElBQUksQ0FBQztxQkFDNUI7Z0JBQ0wsQ0FBQyxDQUFDLENBQUM7Z0JBQ0gsSUFBSSxDQUFDLG1CQUFpQixFQUFFO29CQUNwQixPQUFPLEtBQUksQ0FBQyxtQkFBbUIsQ0FBQyxtQkFBbUIsQ0FBQzt5QkFDL0MsSUFBSSxDQUNELEdBQUcsQ0FBQyxVQUFDLFNBQWlCO3dCQUNsQixTQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO3dCQUN4QixJQUFJLFFBQU0sSUFBSSxRQUFNLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxFQUFFOzRCQUM1QyxRQUFNLENBQUMsU0FBUyxDQUFDLEdBQUcsU0FBTyxDQUFDO3lCQUMvQjs2QkFBTTs0QkFDSCxVQUFRLENBQUMsU0FBUyxDQUFDLEdBQUcsU0FBTyxDQUFDO3lCQUNqQzt3QkFDRCxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBUSxDQUFDLENBQUM7b0JBQ3BDLENBQUMsQ0FBQyxFQUNGLFFBQVEsQ0FBQyxVQUFDLEtBQWE7d0JBQ25CLE9BQU8sS0FBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO29CQUNuRCxDQUFDLENBQUMsQ0FDTCxDQUFDO2lCQUNUO3FCQUFNO29CQUNILE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO2lCQUNuQjthQUNKO1FBQ0wsQ0FBQyxDQUFDLENBQ0wsQ0FBQztJQUNWLENBQUM7SUFHTSx1REFBbUIsR0FBMUIsVUFBMkIsbUJBQXdDO1FBQW5FLGlCQXNDQztRQXJDRyxPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsZ0JBQWdCLENBQUM7WUFDeEMsU0FBUyxFQUFFLG1CQUFtQixDQUFDLFFBQVE7WUFDdkMsYUFBYSxFQUFFLEVBQUU7U0FDcEIsQ0FBQzthQUNHLElBQUksQ0FDRCxHQUFHLENBQUMsVUFBQyxNQUFlO1lBQ2hCLE9BQU8sS0FBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3pDLENBQUMsQ0FBQyxFQUNGLFFBQVEsQ0FBQyxVQUFDLGFBQXFCO1lBQzNCLE9BQU8sS0FBSSxDQUFDLGNBQWMsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFDLFNBQVMsRUFBRSxtQkFBbUIsQ0FBQyxRQUFRLEVBQUMsQ0FBQztpQkFDbEYsSUFBSSxDQUNELFFBQVEsQ0FBQyxVQUFDLE9BQWdCO2dCQUN0QixJQUFNLE1BQU0sR0FBVyxFQUFFLENBQUM7Z0JBQzFCLE1BQU0sQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDO2dCQUNwQixNQUFNLENBQUMsTUFBTSxHQUFHLG1CQUFtQixDQUFDLE1BQU0sQ0FBQztnQkFDM0MsTUFBTSxDQUFDLE9BQU8sR0FBRyxtQkFBbUIsQ0FBQyxPQUFPLENBQUM7Z0JBQzdDLE1BQU0sQ0FBQyxRQUFRLEdBQUcsbUJBQW1CLENBQUMsUUFBUSxDQUFDO2dCQUMvQyxNQUFNLENBQUMsU0FBUyxHQUFHLG1CQUFtQixDQUFDLFFBQVEsQ0FBQztnQkFDaEQsTUFBTSxDQUFDLGNBQWMsR0FBRyxhQUFhLENBQUM7Z0JBQ3RDLElBQU0sS0FBSyxHQUEyQixFQUFFLENBQUM7Z0JBQ3pDLEtBQUssQ0FBQyxZQUFZLENBQUMsR0FBRyxtQkFBbUIsQ0FBQyxPQUFPLENBQUM7Z0JBQ2xELEtBQUssQ0FBQyxRQUFRLENBQUMsR0FBRyxtQkFBbUIsQ0FBQyxXQUFXLENBQUM7Z0JBQ2xELE1BQU0sQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO2dCQUNyQixJQUFJLE9BQU8sRUFBRTtvQkFDVCxNQUFNLENBQUMsVUFBVSxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDO29CQUM3QyxJQUFJLE9BQU8sQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsRUFBRTt3QkFDcEQsTUFBTSxDQUFDLGFBQWEsR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQztxQkFDdEQ7eUJBQU07d0JBQ0gsTUFBTSxDQUFDLGFBQWEsR0FBRyxXQUFXOzZCQUM3QixXQUFXLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztxQkFDL0U7aUJBQ0o7Z0JBQ0QsT0FBTyxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDdEIsQ0FBQyxDQUFDLENBQ0wsQ0FBQztRQUNWLENBQUMsQ0FBQyxDQUNMLENBQUM7SUFDVixDQUFDO0lBRU8sb0RBQWdCLEdBQXhCLFVBQXlCLEdBQVk7UUFBckMsaUJBVUM7UUFURyxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFO1lBQ3ZDLE9BQU8sQ0FBQyxDQUFDO1NBQ1o7UUFFRCxPQUFPLEdBQUcsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLFVBQUMsR0FBRyxFQUFFLEtBQUs7WUFDbEMsR0FBRyxJQUFJLEtBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUVwQyxPQUFPLEdBQUcsQ0FBQztRQUNmLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNWLENBQUM7SUFuSHVCLHlEQUErQixHQUFHLGlCQUFpQixDQUFDO0lBcUhoRixnQ0FBQztDQUFBLEFBdEhELElBc0hDO1NBdEhZLHlCQUF5QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7RGJTZXJ2aWNlfSBmcm9tICcuLi8uLi9kYic7XG5pbXBvcnQge0NvdXJzZSwgRW5yb2xsQ291cnNlUmVxdWVzdH0gZnJvbSAnLi4nO1xuaW1wb3J0IHtDb250ZW50LCBDb250ZW50U2VydmljZX0gZnJvbSAnLi4vLi4vY29udGVudCc7XG5pbXBvcnQge09ic2VydmFibGUsIG9mfSBmcm9tICdyeGpzJztcbmltcG9ydCB7S2V5VmFsdWVTdG9yZX0gZnJvbSAnLi4vLi4va2V5LXZhbHVlLXN0b3JlJztcbmltcG9ydCB7Q29udGVudFV0aWx9IGZyb20gJy4uLy4uL2NvbnRlbnQvdXRpbC9jb250ZW50LXV0aWwnO1xuaW1wb3J0IHttYXAsIG1lcmdlTWFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmV4cG9ydCBjbGFzcyBPZmZsaW5lQ291cnNlQ2FjaGVIYW5kbGVyIHtcbiAgICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBHRVRfRU5ST0xMRURfQ09VUlNFU19LRVlfUFJFRklYID0gJ2Vucm9sbGVkQ291cnNlcyc7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGRiU2VydmljZTogRGJTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgY29udGVudFNlcnZpY2U6IENvbnRlbnRTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUga2V5VmFsdWVTdG9yZTogS2V5VmFsdWVTdG9yZSkge1xuXG4gICAgfVxuXG4gICAgcHVibGljIGFkZE5ld2x5RW5yb2xsZWRDb3Vyc2VUb0dldEVucm9sbGVkQ291cnNlcyhlbnJvbGxDb3Vyc2VSZXF1ZXN0OiBFbnJvbGxDb3Vyc2VSZXF1ZXN0KTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgICAgIGNvbnN0IGtleSA9IE9mZmxpbmVDb3Vyc2VDYWNoZUhhbmRsZXIuR0VUX0VOUk9MTEVEX0NPVVJTRVNfS0VZX1BSRUZJWC5jb25jYXQoZW5yb2xsQ291cnNlUmVxdWVzdC51c2VySWQpO1xuICAgICAgICByZXR1cm4gdGhpcy5rZXlWYWx1ZVN0b3JlLmdldFZhbHVlKGtleSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1lcmdlTWFwKChlbnJvbGxlZENvdXJzZXNJbkRCOiBzdHJpbmcgfCB1bmRlZmluZWQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFlbnJvbGxlZENvdXJzZXNJbkRCKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXROZXdseUFkZGVkQ291cnNlKGVucm9sbENvdXJzZVJlcXVlc3QpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcCgoY291cnNlOiBDb3Vyc2UpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvdXJzZUxpc3Q6IENvdXJzZVtdID0gW107XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb3Vyc2VMaXN0LnB1c2goY291cnNlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjb3Vyc2VMaXN0O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVyZ2VNYXAoKGxpc3Q6IENvdXJzZVtdKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5rZXlWYWx1ZVN0b3JlLnNldFZhbHVlKGtleSwgSlNPTi5zdHJpbmdpZnkobGlzdCkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IEpTT04ucGFyc2UoZW5yb2xsZWRDb3Vyc2VzSW5EQik7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSByZXNwb25zZVsncmVzdWx0J107XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgY291cnNlczogQ291cnNlW107XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0ICYmIHJlc3VsdC5oYXNPd25Qcm9wZXJ0eSgnY291cnNlcycpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY291cnNlcyA9IHJlc3VsdFsnY291cnNlcyddO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb3Vyc2VzID0gcmVzcG9uc2VbJ2NvdXJzZXMnXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBpc0NvdXJzZUF2YWlsYWJsZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgY291cnNlcy5mb3JFYWNoKChjb3Vyc2U6IENvdXJzZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb3Vyc2UuY291cnNlSWQgPT09IGVucm9sbENvdXJzZVJlcXVlc3QuY291cnNlSWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNDb3Vyc2VBdmFpbGFibGUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0NvdXJzZUF2YWlsYWJsZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldE5ld2x5QWRkZWRDb3Vyc2UoZW5yb2xsQ291cnNlUmVxdWVzdClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXAoKG5ld0NvdXJzZTogQ291cnNlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY291cnNlcy5wdXNoKG5ld0NvdXJzZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdCAmJiByZXN1bHQuaGFzT3duUHJvcGVydHkoJ2NvdXJzZXMnKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRbJ2NvdXJzZXMnXSA9IGNvdXJzZXM7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VbJ2NvdXJzZXMnXSA9IGNvdXJzZXM7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShyZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lcmdlTWFwKCh2YWx1ZTogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMua2V5VmFsdWVTdG9yZS5zZXRWYWx1ZShrZXksIHZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvZih0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApO1xuICAgIH1cblxuXG4gICAgcHVibGljIGdldE5ld2x5QWRkZWRDb3Vyc2UoZW5yb2xsQ291cnNlUmVxdWVzdDogRW5yb2xsQ291cnNlUmVxdWVzdCk6IE9ic2VydmFibGU8Q291cnNlPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmNvbnRlbnRTZXJ2aWNlLmdldENoaWxkQ29udGVudHMoe1xuICAgICAgICAgICAgY29udGVudElkOiBlbnJvbGxDb3Vyc2VSZXF1ZXN0LmNvdXJzZUlkLFxuICAgICAgICAgICAgaGllcmFyY2h5SW5mbzogW11cbiAgICAgICAgfSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCgocmVzdWx0OiBDb250ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldExlYWZOb2RlQ291bnQocmVzdWx0KTtcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBtZXJnZU1hcCgobGVhZk5vZGVDb3VudDogbnVtYmVyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbnRlbnRTZXJ2aWNlLmdldENvbnRlbnREZXRhaWxzKHtjb250ZW50SWQ6IGVucm9sbENvdXJzZVJlcXVlc3QuY291cnNlSWR9KVxuICAgICAgICAgICAgICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVyZ2VNYXAoKGNvbnRlbnQ6IENvbnRlbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY291cnNlOiBDb3Vyc2UgPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY291cnNlLnByb2dyZXNzID0gMDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY291cnNlLnVzZXJJZCA9IGVucm9sbENvdXJzZVJlcXVlc3QudXNlcklkO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb3Vyc2UuYmF0Y2hJZCA9IGVucm9sbENvdXJzZVJlcXVlc3QuYmF0Y2hJZDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY291cnNlLmNvdXJzZUlkID0gZW5yb2xsQ291cnNlUmVxdWVzdC5jb3Vyc2VJZDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY291cnNlLmNvbnRlbnRJZCA9IGVucm9sbENvdXJzZVJlcXVlc3QuY291cnNlSWQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvdXJzZS5sZWFmTm9kZXNDb3VudCA9IGxlYWZOb2RlQ291bnQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhdGNoOiB7IFtrZXk6IHN0cmluZ106IGFueSB9ID0ge307XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJhdGNoWydpZGVudGlmaWVyJ10gPSBlbnJvbGxDb3Vyc2VSZXF1ZXN0LmJhdGNoSWQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJhdGNoWydzdGF0dXMnXSA9IGVucm9sbENvdXJzZVJlcXVlc3QuYmF0Y2hTdGF0dXM7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvdXJzZS5iYXRjaCA9IGJhdGNoO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29udGVudCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY291cnNlLmNvdXJzZU5hbWUgPSBjb250ZW50LmNvbnRlbnREYXRhLm5hbWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29udGVudC5jb250ZW50RGF0YS5hcHBJY29uLnN0YXJ0c1dpdGgoJ2h0dHBzOi8vJykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb3Vyc2UuY291cnNlTG9nb1VybCA9IGNvbnRlbnQuY29udGVudERhdGEuYXBwSWNvbjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY291cnNlLmNvdXJzZUxvZ29VcmwgPSBDb250ZW50VXRpbFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZ2V0QmFzZVBhdGgoY29udGVudC5iYXNlUGF0aC5jb25jYXQoJy8nLCBjb250ZW50LmNvbnRlbnREYXRhLmFwcEljb24pKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2YoY291cnNlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldExlYWZOb2RlQ291bnQob2JqOiBDb250ZW50KTogbnVtYmVyIHtcbiAgICAgICAgaWYgKCFvYmouY2hpbGRyZW4gfHwgIW9iai5jaGlsZHJlbi5sZW5ndGgpIHtcbiAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG9iai5jaGlsZHJlbi5yZWR1Y2UoKGFjYywgY2hpbGQpID0+IHtcbiAgICAgICAgICAgIGFjYyArPSB0aGlzLmdldExlYWZOb2RlQ291bnQoY2hpbGQpO1xuXG4gICAgICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgICB9LCAwKTtcbiAgICB9XG5cbn1cbiJdfQ==