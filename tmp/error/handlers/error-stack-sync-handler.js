import { EMPTY, of, throwError } from 'rxjs';
import { ErrorStackEntry } from '../db/schema';
import { HttpRequestType, Request } from '../../api';
import { NetworkStatus } from '../../util/network';
import { ErrorStackMapper } from '../util/error-stack-mapper';
import { catchError, expand, map, mapTo, mergeMap } from 'rxjs/operators';
var _ID = ErrorStackEntry._ID;
var ErrorStackSyncHandler = /** @class */ (function () {
    function ErrorStackSyncHandler(apiService, dbService, errorLoggerConfig, networkInfoService, errorStackSyncRequestDecorator) {
        this.apiService = apiService;
        this.dbService = dbService;
        this.errorLoggerConfig = errorLoggerConfig;
        this.networkInfoService = networkInfoService;
        this.errorStackSyncRequestDecorator = errorStackSyncRequestDecorator;
    }
    ErrorStackSyncHandler.prototype.handle = function (errorSyncBandwidth) {
        var _this = this;
        return this.processBatch(errorSyncBandwidth)
            .pipe(expand(function (processedCount) {
            if (processedCount > 0) {
                return _this.processBatch(errorSyncBandwidth);
            }
            return EMPTY;
        }), mapTo(undefined), catchError(function () { return of(undefined); }));
    };
    ErrorStackSyncHandler.prototype.processBatch = function (errorSyncBandwidth) {
        var _this = this;
        return this.getErrorStackBatch(errorSyncBandwidth)
            .pipe(mergeMap(function (errorStackList) { return _this.sync(errorStackList); }), mergeMap(function (errorStackList) { return _this.clearLogs(errorStackList); }), map(function (errorStackList) { return errorStackList.length; }));
    };
    ErrorStackSyncHandler.prototype.getErrorStackBatch = function (errorSyncBandwidth) {
        return this.dbService.execute("\n                SELECT * FROM " + ErrorStackEntry.TABLE_NAME + "\n                LIMIT " + errorSyncBandwidth + "\n            ");
    };
    ErrorStackSyncHandler.prototype.clearLogs = function (errorStackList) {
        if (!errorStackList.length) {
            return of(errorStackList);
        }
        return this.dbService.execute("\n                DELETE FROM " + ErrorStackEntry.TABLE_NAME + "\n                WHERE " + ErrorStackEntry._ID + " IN (" + errorStackList.map(function (e) { return e[_ID]; }).join(',') + ")\n            ")
            .pipe(mapTo(errorStackList));
    };
    ErrorStackSyncHandler.prototype.sync = function (errorStackList) {
        var _this = this;
        if (!errorStackList.length) {
            return of(errorStackList);
        }
        return this.networkInfoService.networkStatus$
            .pipe(mergeMap(function (status) {
            if (status === NetworkStatus.OFFLINE) {
                return throwError(new Error('Fake Error'));
            }
            var request = {
                pdata: undefined,
                context: undefined,
                logs: errorStackList.map(function (e) { return ErrorStackMapper.mapErrorSatckDBEntryToErrorStack(e); })
            };
            return _this.errorStackSyncRequestDecorator.decorate(request)
                .pipe(mergeMap(function () {
                var apiRequest = new Request.Builder()
                    .withType(HttpRequestType.POST)
                    .withPath(_this.errorLoggerConfig.errorLoggerApiPath)
                    .withBearerToken(true)
                    .withBody({
                    request: request
                })
                    .build();
                return _this.apiService.fetch(apiRequest);
            }));
        }), mapTo(errorStackList));
    };
    return ErrorStackSyncHandler;
}());
export { ErrorStackSyncHandler };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXJyb3Itc3RhY2stc3luYy1oYW5kbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2Vycm9yL2hhbmRsZXJzL2Vycm9yLXN0YWNrLXN5bmMtaGFuZGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsS0FBSyxFQUFjLEVBQUUsRUFBRSxVQUFVLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFDdkQsT0FBTyxFQUFDLGVBQWUsRUFBQyxNQUFNLGNBQWMsQ0FBQztBQUM3QyxPQUFPLEVBQWEsZUFBZSxFQUFFLE9BQU8sRUFBQyxNQUFNLFdBQVcsQ0FBQztBQUcvRCxPQUFPLEVBQXFCLGFBQWEsRUFBQyxNQUFNLG9CQUFvQixDQUFDO0FBQ3JFLE9BQU8sRUFBQyxnQkFBZ0IsRUFBQyxNQUFNLDRCQUE0QixDQUFDO0FBSTVELE9BQU8sRUFBQyxVQUFVLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEUsSUFBTyxHQUFHLEdBQUcsZUFBZSxDQUFDLEdBQUcsQ0FBQztBQW9CakM7SUFDSSwrQkFDWSxVQUFzQixFQUN0QixTQUFvQixFQUNwQixpQkFBb0MsRUFDcEMsa0JBQXNDLEVBQ3RDLDhCQUE4RDtRQUo5RCxlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQ3RCLGNBQVMsR0FBVCxTQUFTLENBQVc7UUFDcEIsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFtQjtRQUNwQyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBQ3RDLG1DQUE4QixHQUE5Qiw4QkFBOEIsQ0FBZ0M7SUFFMUUsQ0FBQztJQUVELHNDQUFNLEdBQU4sVUFBTyxrQkFBMEI7UUFBakMsaUJBYUM7UUFaRyxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsa0JBQWtCLENBQUM7YUFDdkMsSUFBSSxDQUNELE1BQU0sQ0FBQyxVQUFBLGNBQWM7WUFDakIsSUFBSSxjQUFjLEdBQUcsQ0FB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QTtpQkFDVixDQUFDO3FCQUNELEtBQUssRUFBRSxDQUFDO2dCQUViLE9BQU8sS0FBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDN0MsQ0FBQyxDQUFDLENBQ0wsQ0FBQztRQUNWLENBQUMsQ0FBQyxFQUNGLEtBQUssQ0FBQyxjQUFjLENBQUMsQ0FDeEIsQ0FBQztJQUNWLENBQUM7SUFDTCw0QkFBQztBQUFELENBQUMsQUE1RkQsSUE0RkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0VNUFRZLCBPYnNlcnZhYmxlLCBvZiwgdGhyb3dFcnJvcn0gZnJvbSAncnhqcyc7XG5pbXBvcnQge0Vycm9yU3RhY2tFbnRyeX0gZnJvbSAnLi4vZGIvc2NoZW1hJztcbmltcG9ydCB7QXBpU2VydmljZSwgSHR0cFJlcXVlc3RUeXBlLCBSZXF1ZXN0fSBmcm9tICcuLi8uLi9hcGknO1xuaW1wb3J0IHtEYlNlcnZpY2V9IGZyb20gJy4uLy4uL2RiJztcbmltcG9ydCB7RXJyb3JMb2dnZXJDb25maWd9IGZyb20gJy4uL2NvbmZpZy9lcnJvci1sb2dnZXItY29uZmlnJztcbmltcG9ydCB7TmV0d29ya0luZm9TZXJ2aWNlLCBOZXR3b3JrU3RhdHVzfSBmcm9tICcuLi8uLi91dGlsL25ldHdvcmsnO1xuaW1wb3J0IHtFcnJvclN0YWNrTWFwcGVyfSBmcm9tICcuLi91dGlsL2Vycm9yLXN0YWNrLW1hcHBlcic7XG5pbXBvcnQge0Vycm9yU3RhY2t9IGZyb20gJy4uL2RlZi9lcnJvci1zdGFjayc7XG5pbXBvcnQge0RldmljZVNwZWN9IGZyb20gJy4uLy4uL3V0aWwvZGV2aWNlJztcbmltcG9ydCB7RXJyb3JTdGFja1N5bmNSZXF1ZXN0RGVjb3JhdG9yfSBmcm9tICcuL2Vycm9yLXN0YWNrLXN5bmMtcmVxdWVzdC1kZWNvcmF0b3InO1xuaW1wb3J0IHtjYXRjaEVycm9yLCBleHBhbmQsIG1hcCwgbWFwVG8sIG1lcmdlTWFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgX0lEID0gRXJyb3JTdGFja0VudHJ5Ll9JRDtcblxuaW50ZXJmYWNlIEVycm9yTG9nZ2VyUmVxdWVzdCB7XG4gICAgcGRhdGE6IFByb2R1Y2VyRGF0YTtcbiAgICBjb250ZXh0OiBDb250ZXh0O1xuICAgIGxvZ3M6IEFycmF5PEVycm9yU3RhY2s+O1xufVxuXG5pbnRlcmZhY2UgUHJvZHVjZXJEYXRhIHtcbiAgICBpZDogc3RyaW5nO1xuICAgIHBpZDogc3RyaW5nO1xuICAgIHZlcjogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgQ29udGV4dCB7XG4gICAgZGlkOiBzdHJpbmc7XG4gICAgZHNwZWM6IERldmljZVNwZWM7XG4gICAgZXh0cmFzOiBhbnk7XG59XG5cbmV4cG9ydCBjbGFzcyBFcnJvclN0YWNrU3luY0hhbmRsZXIge1xuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIGFwaVNlcnZpY2U6IEFwaVNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgZGJTZXJ2aWNlOiBEYlNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgZXJyb3JMb2dnZXJDb25maWc6IEVycm9yTG9nZ2VyQ29uZmlnLFxuICAgICAgICBwcml2YXRlIG5ldHdvcmtJbmZvU2VydmljZTogTmV0d29ya0luZm9TZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIGVycm9yU3RhY2tTeW5jUmVxdWVzdERlY29yYXRvcjogRXJyb3JTdGFja1N5bmNSZXF1ZXN0RGVjb3JhdG9yXG4gICAgKSB7XG4gICAgfVxuXG4gICAgaGFuZGxlKGVycm9yU3luY0JhbmR3aWR0aDogbnVtYmVyKTogT2JzZXJ2YWJsZTx1bmRlZmluZWQ+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJvY2Vzc0JhdGNoKGVycm9yU3luY0JhbmR3aWR0aClcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIGV4cGFuZChwcm9jZXNzZWRDb3VudCA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwcm9jZXNzZWRDb3VudCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnByb2Nlc3NCYXRjaChlcnJvclN5bmNCYW5kd2lkdGgpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEVNUFRZO1xuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIG1hcFRvKHVuZGVmaW5lZCksXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoKSA9PiBvZih1bmRlZmluZWQpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHByb2Nlc3NCYXRjaChlcnJvclN5bmNCYW5kd2lkdGg6IG51bWJlcik6IE9ic2VydmFibGU8bnVtYmVyPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldEVycm9yU3RhY2tCYXRjaChlcnJvclN5bmNCYW5kd2lkdGgpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtZXJnZU1hcCgoZXJyb3JTdGFja0xpc3QpID0+IHRoaXMuc3luYyhlcnJvclN0YWNrTGlzdCkpLFxuICAgICAgICAgICAgICAgIG1lcmdlTWFwKChlcnJvclN0YWNrTGlzdCkgPT4gdGhpcy5jbGVhckxvZ3MoZXJyb3JTdGFja0xpc3QpKSxcbiAgICAgICAgICAgICAgICBtYXAoKGVycm9yU3RhY2tMaXN0KSA9PiBlcnJvclN0YWNrTGlzdC5sZW5ndGgpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0RXJyb3JTdGFja0JhdGNoKGVycm9yU3luY0JhbmR3aWR0aDogbnVtYmVyKTogT2JzZXJ2YWJsZTxFcnJvclN0YWNrRW50cnkuU2NoZW1hTWFwW10+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGJTZXJ2aWNlLmV4ZWN1dGUoYFxuICAgICAgICAgICAgICAgIFNFTEVDVCAqIEZST00gJHtFcnJvclN0YWNrRW50cnkuVEFCTEVfTkFNRX1cbiAgICAgICAgICAgICAgICBMSU1JVCAke2Vycm9yU3luY0JhbmR3aWR0aH1cbiAgICAgICAgICAgIGApO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2xlYXJMb2dzKGVycm9yU3RhY2tMaXN0OiBFcnJvclN0YWNrRW50cnkuU2NoZW1hTWFwW10pOiBPYnNlcnZhYmxlPEVycm9yU3RhY2tFbnRyeS5TY2hlbWFNYXBbXT4ge1xuICAgICAgICBpZiAoIWVycm9yU3RhY2tMaXN0Lmxlbmd0aCkge1xuICAgICAgICAgICAgcmV0dXJuIG9mKGVycm9yU3RhY2tMaXN0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLmRiU2VydmljZS5leGVjdXRlKGBcbiAgICAgICAgICAgICAgICBERUxFVEUgRlJPTSAke0Vycm9yU3RhY2tFbnRyeS5UQUJMRV9OQU1FfVxuICAgICAgICAgICAgICAgIFdIRVJFICR7RXJyb3JTdGFja0VudHJ5Ll9JRH0gSU4gKCR7ZXJyb3JTdGFja0xpc3QubWFwKChlKSA9PiBlW19JRF0pLmpvaW4oJywnKX0pXG4gICAgICAgICAgICBgKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwVG8oZXJyb3JTdGFja0xpc3QpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgc3luYyhlcnJvclN0YWNrTGlzdDogRXJyb3JTdGFja0VudHJ5LlNjaGVtYU1hcFtdKTogT2JzZXJ2YWJsZTxFcnJvclN0YWNrRW50cnkuU2NoZW1hTWFwW10+IHtcbiAgICAgICAgaWYgKCFlcnJvclN0YWNrTGlzdC5sZW5ndGgpIHtcbiAgICAgICAgICAgIHJldHVybiBvZihlcnJvclN0YWNrTGlzdCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5uZXR3b3JrSW5mb1NlcnZpY2UubmV0d29ya1N0YXR1cyRcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1lcmdlTWFwKChzdGF0dXMpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXR1cyA9PT0gTmV0d29ya1N0YXR1cy5PRkZMSU5FKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcihuZXcgRXJyb3IoJ0Zha2UgRXJyb3InKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBjb25zdCByZXF1ZXN0ID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcGRhdGE6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQ6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ3M6IGVycm9yU3RhY2tMaXN0Lm1hcChlID0+IEVycm9yU3RhY2tNYXBwZXIubWFwRXJyb3JTYXRja0RCRW50cnlUb0Vycm9yU3RhY2soZSkpXG4gICAgICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXJyb3JTdGFja1N5bmNSZXF1ZXN0RGVjb3JhdG9yLmRlY29yYXRlKHJlcXVlc3QpXG4gICAgICAgICAgICAgICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXJnZU1hcCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFwaVJlcXVlc3Q6IFJlcXVlc3QgPSBuZXcgUmVxdWVzdC5CdWlsZGVyKClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC53aXRoVHlwZShIdHRwUmVxdWVzdFR5cGUuUE9TVClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC53aXRoUGF0aCh0aGlzLmVycm9yTG9nZ2VyQ29uZmlnLmVycm9yTG9nZ2VyQXBpUGF0aClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC53aXRoQmVhcmVyVG9rZW4odHJ1ZSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC53aXRoQm9keSh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWVzdFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5idWlsZCgpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmFwaVNlcnZpY2UuZmV0Y2goYXBpUmVxdWVzdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgbWFwVG8oZXJyb3JTdGFja0xpc3QpXG4gICAgICAgICAgICApO1xuICAgIH1cbn1cbiJdfQ==