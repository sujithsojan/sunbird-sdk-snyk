import { CachedItemRequestSourceFrom } from '../../key-value-store';
import { Path } from '../../util/file/util/path';
import { HttpRequestType, Request } from '../../api';
import { FrameworkMapper } from '../util/framework-mapper';
import { defer, from, iif } from 'rxjs';
import { map, mergeMap } from 'rxjs/operators';
var GetFrameworkDetailsHandler = /** @class */ (function () {
    function GetFrameworkDetailsHandler(frameworkService, apiService, frameworkServiceConfig, fileService, cachedItemStore) {
        this.frameworkService = frameworkService;
        this.apiService = apiService;
        this.frameworkServiceConfig = frameworkServiceConfig;
        this.fileService = fileService;
        this.cachedItemStore = cachedItemStore;
        this.FRAMEWORK_FILE_KEY_PREFIX = 'framework-';
        this.FRAMEWORK_LOCAL_KEY = 'framework-';
        this.GET_FRAMEWORK_DETAILS_ENDPOINT = '/read';
    }
    GetFrameworkDetailsHandler.prototype.handle = function (request) {
        var _this = this;
        return iif(function () { return !!request.frameworkId; }, defer(function () {
            return _this.cachedItemStore[request.from === CachedItemRequestSourceFrom.SERVER ? 'get' : 'getCached'](request.frameworkId, _this.FRAMEWORK_LOCAL_KEY, 'ttl_' + _this.FRAMEWORK_LOCAL_KEY, function () { return _this.fetchFromServer(request); }, function () { return _this.fetchFromFile(request); });
        }), defer(function () {
            return _this.frameworkService.getDefaultChannelDetails().pipe(mergeMap(function (channel) {
                return _this.frameworkService.getFrameworkDetails({
                    from: request.from,
                    frameworkId: channel.defaultFramework,
                    requiredCategories: request.requiredCategories
                });
            }));
        }));
    };
    GetFrameworkDetailsHandler.prototype.fetchFromServer = function (request) {
        var apiRequest = new Request.Builder()
            .withType(HttpRequestType.GET)
            .withPath(this.frameworkServiceConfig.frameworkApiPath + this.GET_FRAMEWORK_DETAILS_ENDPOINT + '/' + request.frameworkId)
            .withParameters({ categories: request.requiredCategories.join(',') })
            .withBearerToken(true)
            .build();
        return this.apiService.fetch(apiRequest).pipe(map(function (response) {
            return response.body.result.framework;
        }), map(function (framework) {
            return FrameworkMapper.prepareFrameworkCategoryAssociations(framework);
        }));
    };
    GetFrameworkDetailsHandler.prototype.fetchFromFile = function (request) {
        var dir = Path.getAssetPath() + this.frameworkServiceConfig.frameworkConfigDirPath;
        var file = this.FRAMEWORK_FILE_KEY_PREFIX + request.frameworkId + '.json';
        return from(this.fileService.readFileFromAssets(dir.concat('/', file))).pipe(map(function (filecontent) {
            var result = JSON.parse(filecontent);
            return result.result.framework;
        }), map(function (framework) {
            return FrameworkMapper.prepareFrameworkCategoryAssociations(framework);
        }));
    };
    return GetFrameworkDetailsHandler;
}());
export { GetFrameworkDetailsHandler };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LWZyYW1ld29yay1kZXRhaWwtaGFuZGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9mcmFtZXdvcmsvaGFuZGxlci9nZXQtZnJhbWV3b3JrLWRldGFpbC1oYW5kbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQywyQkFBMkIsRUFBa0IsTUFBTSx1QkFBdUIsQ0FBQztBQUNuRixPQUFPLEVBQUMsSUFBSSxFQUFDLE1BQU0sMkJBQTJCLENBQUM7QUFFL0MsT0FBTyxFQUFnQyxlQUFlLEVBQUUsT0FBTyxFQUFDLE1BQU0sV0FBVyxDQUFDO0FBRWxGLE9BQU8sRUFBQyxlQUFlLEVBQUMsTUFBTSwwQkFBMEIsQ0FBQztBQUN6RCxPQUFPLEVBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQWEsTUFBTSxNQUFNLENBQUM7QUFDbEQsT0FBTyxFQUFDLEdBQUcsRUFBRSxRQUFRLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUc3QztJQU1JLG9DQUFvQixnQkFBa0MsRUFDbEMsVUFBc0IsRUFDdEIsc0JBQThDLEVBQzlDLFdBQXdCLEVBQ3hCLGVBQWdDO1FBSmhDLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQUN0QiwyQkFBc0IsR0FBdEIsc0JBQXNCLENBQXdCO1FBQzlDLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBQ3hCLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQVRuQyw4QkFBeUIsR0FBRyxZQUFZLENBQUM7UUFDekMsd0JBQW1CLEdBQUcsWUFBWSxDQUFDO1FBQ25DLG1DQUE4QixHQUFHLE9BQU8sQ0FBQztJQVExRCxDQUFDO0lBRUQsMkNBQU0sR0FBTixVQUFPLE9BQWdDO1FBQXZDLGlCQXVCQztRQXRCRyxPQUFPLEdBQUcsQ0FDTixjQUFNLE9BQUEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQXJCLENBQXFCLEVBQzNCLEtBQUssQ0FBQztZQUNGLE9BQU8sS0FBSSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsSUFBSSxLQUFLLDJCQUEyQixDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FDbEcsT0FBTyxDQUFDLFdBQVksRUFDcEIsS0FBSSxDQUFDLG1CQUFtQixFQUN4QixNQUFNLEdBQUcsS0FBSSxDQUFDLG1CQUFtQixFQUNqQyxjQUFNLE9BQUEsS0FBSSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsRUFBN0IsQ0FBNkIsRUFDbkMsY0FBTSxPQUFBLEtBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLEVBQTNCLENBQTJCLENBQUMsQ0FBQztRQUMzQyxDQUFDLENBQUMsRUFDRixLQUFLLENBQUM7WUFDRixPQUFPLEtBQUksQ0FBQyxnQkFBZ0IsQ0FBQyx3QkFBd0IsRUFBRSxDQUFDLElBQUksQ0FDeEQsUUFBUSxDQUFDLFVBQUMsT0FBZ0I7Z0JBQ3RCLE9BQUEsS0FBSSxDQUFDLGdCQUFnQixDQUFDLG1CQUFtQixDQUFDO29CQUN0QyxJQUFJLEVBQUUsT0FBTyxDQUFDLElBQUk7b0JBQ2xCLFdBQVcsRUFBRSxPQUFPLENBQUMsZ0JBQWdCO29CQUNyQyxrQkFBa0IsRUFBRSxPQUFPLENBQUMsa0JBQWtCO2lCQUNqRCxDQUFDO1lBSkYsQ0FJRSxDQUNMLENBQ0osQ0FBQztRQUNOLENBQUMsQ0FBQyxDQUNMLENBQUM7SUFDTixDQUFDO0lBRU8sb0RBQWUsR0FBdkIsVUFBd0IsT0FBZ0M7UUFDcEQsSUFBTSxVQUFVLEdBQVksSUFBSSxPQUFPLENBQUMsT0FBTyxFQUFFO2FBQzVDLFFBQVEsQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDO2FBQzdCLFFBQVEsQ0FBQyxJQUFJLENBQUMsc0JBQXNCLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLDhCQUE4QixHQUFHLEdBQUcsR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDO2FBQ3hILGNBQWMsQ0FBQyxFQUFDLFVBQVUsRUFBRSxPQUFPLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFDLENBQUM7YUFDbEUsZUFBZSxDQUFDLElBQUksQ0FBQzthQUNyQixLQUFLLEVBQUUsQ0FBQztRQUViLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQXVDLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FDL0UsR0FBRyxDQUFDLFVBQUMsUUFBUTtZQUNULE9BQU8sUUFBUSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDO1FBQzFDLENBQUMsQ0FBQyxFQUNGLEdBQUcsQ0FBQyxVQUFDLFNBQW9CO1lBQ3JCLE9BQU8sZUFBZSxDQUFDLG9DQUFvQyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQzNFLENBQUMsQ0FBQyxDQUNMLENBQUM7SUFDTixDQUFDO0lBRU8sa0RBQWEsR0FBckIsVUFBc0IsT0FBZ0M7UUFDbEQsSUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLFlBQVksRUFBRSxHQUFHLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxzQkFBc0IsQ0FBQztRQUNyRixJQUFNLElBQUksR0FBRyxJQUFJLENBQUMseUJBQXlCLEdBQUcsT0FBTyxDQUFDLFdBQVcsR0FBRyxPQUFPLENBQUM7UUFFNUUsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUN4RSxHQUFHLENBQUMsVUFBQyxXQUFtQjtZQUNwQixJQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQ3ZDLE9BQU8sTUFBTSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUM7UUFDbkMsQ0FBQyxDQUFDLEVBQ0YsR0FBRyxDQUFDLFVBQUMsU0FBb0I7WUFDckIsT0FBTyxlQUFlLENBQUMsb0NBQW9DLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDM0UsQ0FBQyxDQUFDLENBQ0wsQ0FBQztJQUNOLENBQUM7SUFFTCxpQ0FBQztBQUFELENBQUMsQUF2RUQsSUF1RUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0NhY2hlZEl0ZW1SZXF1ZXN0U291cmNlRnJvbSwgQ2FjaGVkSXRlbVN0b3JlfSBmcm9tICcuLi8uLi9rZXktdmFsdWUtc3RvcmUnO1xuaW1wb3J0IHtQYXRofSBmcm9tICcuLi8uLi91dGlsL2ZpbGUvdXRpbC9wYXRoJztcbmltcG9ydCB7RmlsZVNlcnZpY2V9IGZyb20gJy4uLy4uL3V0aWwvZmlsZS9kZWYvZmlsZS1zZXJ2aWNlJztcbmltcG9ydCB7QXBpUmVxdWVzdEhhbmRsZXIsIEFwaVNlcnZpY2UsIEh0dHBSZXF1ZXN0VHlwZSwgUmVxdWVzdH0gZnJvbSAnLi4vLi4vYXBpJztcbmltcG9ydCB7Q2hhbm5lbCwgRnJhbWV3b3JrLCBGcmFtZXdvcmtEZXRhaWxzUmVxdWVzdCwgRnJhbWV3b3JrU2VydmljZSwgRnJhbWV3b3JrU2VydmljZUNvbmZpZ30gZnJvbSAnLi4nO1xuaW1wb3J0IHtGcmFtZXdvcmtNYXBwZXJ9IGZyb20gJy4uL3V0aWwvZnJhbWV3b3JrLW1hcHBlcic7XG5pbXBvcnQge2RlZmVyLCBmcm9tLCBpaWYsIE9ic2VydmFibGV9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHttYXAsIG1lcmdlTWFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cblxuZXhwb3J0IGNsYXNzIEdldEZyYW1ld29ya0RldGFpbHNIYW5kbGVyIGltcGxlbWVudHMgQXBpUmVxdWVzdEhhbmRsZXI8RnJhbWV3b3JrRGV0YWlsc1JlcXVlc3QsIEZyYW1ld29yaz4ge1xuICAgIHByaXZhdGUgcmVhZG9ubHkgRlJBTUVXT1JLX0ZJTEVfS0VZX1BSRUZJWCA9ICdmcmFtZXdvcmstJztcbiAgICBwcml2YXRlIHJlYWRvbmx5IEZSQU1FV09SS19MT0NBTF9LRVkgPSAnZnJhbWV3b3JrLSc7XG4gICAgcHJpdmF0ZSByZWFkb25seSBHRVRfRlJBTUVXT1JLX0RFVEFJTFNfRU5EUE9JTlQgPSAnL3JlYWQnO1xuXG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGZyYW1ld29ya1NlcnZpY2U6IEZyYW1ld29ya1NlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBhcGlTZXJ2aWNlOiBBcGlTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgZnJhbWV3b3JrU2VydmljZUNvbmZpZzogRnJhbWV3b3JrU2VydmljZUNvbmZpZyxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGZpbGVTZXJ2aWNlOiBGaWxlU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGNhY2hlZEl0ZW1TdG9yZTogQ2FjaGVkSXRlbVN0b3JlKSB7XG4gICAgfVxuXG4gICAgaGFuZGxlKHJlcXVlc3Q6IEZyYW1ld29ya0RldGFpbHNSZXF1ZXN0KTogT2JzZXJ2YWJsZTxGcmFtZXdvcms+IHtcbiAgICAgICAgcmV0dXJuIGlpZihcbiAgICAgICAgICAgICgpID0+ICEhcmVxdWVzdC5mcmFtZXdvcmtJZCxcbiAgICAgICAgICAgIGRlZmVyKCgpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jYWNoZWRJdGVtU3RvcmVbcmVxdWVzdC5mcm9tID09PSBDYWNoZWRJdGVtUmVxdWVzdFNvdXJjZUZyb20uU0VSVkVSID8gJ2dldCcgOiAnZ2V0Q2FjaGVkJ10oXG4gICAgICAgICAgICAgICAgICAgIHJlcXVlc3QuZnJhbWV3b3JrSWQhLFxuICAgICAgICAgICAgICAgICAgICB0aGlzLkZSQU1FV09SS19MT0NBTF9LRVksXG4gICAgICAgICAgICAgICAgICAgICd0dGxfJyArIHRoaXMuRlJBTUVXT1JLX0xPQ0FMX0tFWSxcbiAgICAgICAgICAgICAgICAgICAgKCkgPT4gdGhpcy5mZXRjaEZyb21TZXJ2ZXIocmVxdWVzdCksXG4gICAgICAgICAgICAgICAgICAgICgpID0+IHRoaXMuZmV0Y2hGcm9tRmlsZShyZXF1ZXN0KSk7XG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIGRlZmVyKCgpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5mcmFtZXdvcmtTZXJ2aWNlLmdldERlZmF1bHRDaGFubmVsRGV0YWlscygpLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgIG1lcmdlTWFwKChjaGFubmVsOiBDaGFubmVsKSA9PlxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5mcmFtZXdvcmtTZXJ2aWNlLmdldEZyYW1ld29ya0RldGFpbHMoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyb206IHJlcXVlc3QuZnJvbSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcmFtZXdvcmtJZDogY2hhbm5lbC5kZWZhdWx0RnJhbWV3b3JrLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVpcmVkQ2F0ZWdvcmllczogcmVxdWVzdC5yZXF1aXJlZENhdGVnb3JpZXNcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGZldGNoRnJvbVNlcnZlcihyZXF1ZXN0OiBGcmFtZXdvcmtEZXRhaWxzUmVxdWVzdCk6IE9ic2VydmFibGU8RnJhbWV3b3JrPiB7XG4gICAgICAgIGNvbnN0IGFwaVJlcXVlc3Q6IFJlcXVlc3QgPSBuZXcgUmVxdWVzdC5CdWlsZGVyKClcbiAgICAgICAgICAgIC53aXRoVHlwZShIdHRwUmVxdWVzdFR5cGUuR0VUKVxuICAgICAgICAgICAgLndpdGhQYXRoKHRoaXMuZnJhbWV3b3JrU2VydmljZUNvbmZpZy5mcmFtZXdvcmtBcGlQYXRoICsgdGhpcy5HRVRfRlJBTUVXT1JLX0RFVEFJTFNfRU5EUE9JTlQgKyAnLycgKyByZXF1ZXN0LmZyYW1ld29ya0lkKVxuICAgICAgICAgICAgLndpdGhQYXJhbWV0ZXJzKHtjYXRlZ29yaWVzOiByZXF1ZXN0LnJlcXVpcmVkQ2F0ZWdvcmllcy5qb2luKCcsJyl9KVxuICAgICAgICAgICAgLndpdGhCZWFyZXJUb2tlbih0cnVlKVxuICAgICAgICAgICAgLmJ1aWxkKCk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuYXBpU2VydmljZS5mZXRjaDx7IHJlc3VsdDogeyBmcmFtZXdvcms6IEZyYW1ld29yayB9IH0+KGFwaVJlcXVlc3QpLnBpcGUoXG4gICAgICAgICAgICBtYXAoKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmJvZHkucmVzdWx0LmZyYW1ld29yaztcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgbWFwKChmcmFtZXdvcms6IEZyYW1ld29yaykgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBGcmFtZXdvcmtNYXBwZXIucHJlcGFyZUZyYW1ld29ya0NhdGVnb3J5QXNzb2NpYXRpb25zKGZyYW1ld29yayk7XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgZmV0Y2hGcm9tRmlsZShyZXF1ZXN0OiBGcmFtZXdvcmtEZXRhaWxzUmVxdWVzdCk6IE9ic2VydmFibGU8RnJhbWV3b3JrPiB7XG4gICAgICAgIGNvbnN0IGRpciA9IFBhdGguZ2V0QXNzZXRQYXRoKCkgKyB0aGlzLmZyYW1ld29ya1NlcnZpY2VDb25maWcuZnJhbWV3b3JrQ29uZmlnRGlyUGF0aDtcbiAgICAgICAgY29uc3QgZmlsZSA9IHRoaXMuRlJBTUVXT1JLX0ZJTEVfS0VZX1BSRUZJWCArIHJlcXVlc3QuZnJhbWV3b3JrSWQgKyAnLmpzb24nO1xuXG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuZmlsZVNlcnZpY2UucmVhZEZpbGVGcm9tQXNzZXRzKGRpci5jb25jYXQoJy8nLCBmaWxlKSkpLnBpcGUoXG4gICAgICAgICAgICBtYXAoKGZpbGVjb250ZW50OiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSBKU09OLnBhcnNlKGZpbGVjb250ZW50KTtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0LnJlc3VsdC5mcmFtZXdvcms7XG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIG1hcCgoZnJhbWV3b3JrOiBGcmFtZXdvcmspID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gRnJhbWV3b3JrTWFwcGVyLnByZXBhcmVGcmFtZXdvcmtDYXRlZ29yeUFzc29jaWF0aW9ucyhmcmFtZXdvcmspO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICB9XG5cbn1cbiJdfQ==