import { BehaviorSubject } from 'rxjs';
import Set from 'typescript-collections/dist/lib/Set';
import { map, mapTo, mergeMap, tap } from 'rxjs/operators';
var SharedPreferencesSetCollectionImpl = /** @class */ (function () {
    function SharedPreferencesSetCollectionImpl(sharedPreferences, key, toStringFunction) {
        this.sharedPreferences = sharedPreferences;
        this.key = key;
        this.toStringFunction = toStringFunction;
        this.changes = new BehaviorSubject(undefined);
    }
    SharedPreferencesSetCollectionImpl.prototype.addAll = function (items) {
        var _this = this;
        return this.asSet()
            .pipe(mergeMap(function (set) {
            items.forEach(function (item) { return set.add(item); });
            return _this.sharedPreferences.putString(_this.key, JSON.stringify(set.toArray())).pipe(mapTo(undefined));
        }), tap(function () { return _this.changes.next(undefined); }));
    };
    SharedPreferencesSetCollectionImpl.prototype.add = function (item) {
        var _this = this;
        return this.asSet()
            .pipe(mergeMap(function (set) {
            set.add(item);
            return _this.sharedPreferences.putString(_this.key, JSON.stringify(set.toArray())).pipe(mapTo(undefined));
        }), tap(function () { return _this.changes.next(undefined); }));
    };
    SharedPreferencesSetCollectionImpl.prototype.clear = function () {
        var _this = this;
        return this.sharedPreferences.putString(this.key, '[]')
            .pipe(mapTo(undefined), tap(function () { return _this.changes.next(undefined); }));
    };
    SharedPreferencesSetCollectionImpl.prototype.remove = function (item) {
        var _this = this;
        return this.asSet()
            .pipe(mergeMap(function (set) {
            var hasRemoved = set.remove(item);
            return _this.sharedPreferences.putString(_this.key, JSON.stringify(set.toArray())).pipe(mapTo(hasRemoved));
        }), tap(function () { return _this.changes.next(undefined); }));
    };
    SharedPreferencesSetCollectionImpl.prototype.contains = function (item) {
        return this.asSet()
            .pipe(map(function (set) {
            return set.contains(item);
        }));
    };
    SharedPreferencesSetCollectionImpl.prototype.asList = function () {
        return this.sharedPreferences.getString(this.key)
            .pipe(map(function (downloadListStringified) {
            if (!downloadListStringified) {
                return [];
            }
            return JSON.parse(downloadListStringified);
        }));
    };
    SharedPreferencesSetCollectionImpl.prototype.asSet = function () {
        var _this = this;
        return this.asList()
            .pipe(map(function (items) {
            return items.reduce(function (acc, item) {
                acc.add(item);
                return acc;
            }, new Set(_this.toStringFunction));
        }));
    };
    SharedPreferencesSetCollectionImpl.prototype.asListChanges = function () {
        var _this = this;
        return this.changes.asObservable()
            .pipe(mergeMap(function () {
            return _this.asList();
        }));
    };
    return SharedPreferencesSetCollectionImpl;
}());
export { SharedPreferencesSetCollectionImpl };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hhcmVkLXByZWZlcmVuY2VzLXNldC1jb2xsZWN0aW9uLWltcGwuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvdXRpbC9zaGFyZWQtcHJlZmVyZW5jZXMvaW1wbC9zaGFyZWQtcHJlZmVyZW5jZXMtc2V0LWNvbGxlY3Rpb24taW1wbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUMsZUFBZSxFQUFzQixNQUFNLE1BQU0sQ0FBQztBQUMxRCxPQUFPLEdBQUcsTUFBTSxxQ0FBcUMsQ0FBQztBQUN0RCxPQUFPLEVBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFFekQ7SUFHSSw0Q0FBb0IsaUJBQW9DLEVBQVUsR0FBVyxFQUFVLGdCQUFzQztRQUF6RyxzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBQVUsUUFBRyxHQUFILEdBQUcsQ0FBUTtRQUFVLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBc0I7UUFGckgsWUFBTyxHQUF1QixJQUFJLGVBQWUsQ0FBWSxTQUFTLENBQUMsQ0FBQztJQUdoRixDQUFDO0lBRUQsbURBQU0sR0FBTixVQUFPLEtBQVU7UUFBakIsaUJBWUM7UUFYRyxPQUFPLElBQUksQ0FBQyxLQUFLLEVBQUU7YUFDZCxJQUFJLENBQ0QsUUFBUSxDQUFDLFVBQUMsR0FBVztZQUNqQixLQUFLLENBQUMsT0FBTyxDQUFDLFVBQUMsSUFBSSxJQUFLLE9BQUEsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBYixDQUFhLENBQUMsQ0FBQztZQUV2QyxPQUFPLEtBQUksQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsS0FBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUNqRixLQUFLLENBQUMsU0FBUyxDQUFDLENBQ25CLENBQUM7UUFDTixDQUFDLENBQUMsRUFDRixHQUFHLENBQUMsY0FBTSxPQUFBLEtBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUE1QixDQUE0QixDQUFDLENBQzFDLENBQUM7SUFDVixDQUFDO0lBRUQsZ0RBQUcsR0FBSCxVQUFJLElBQU87UUFBWCxpQkFZQztRQVhHLE9BQU8sSUFBSSxDQUFDLEtBQUssRUFBRTthQUNkLElBQUksQ0FDRCxRQUFRLENBQUMsVUFBQyxHQUFXO1lBQ2pCLEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7WUFFZCxPQUFPLEtBQUksQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsS0FBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUNqRixLQUFLLENBQUMsU0FBUyxDQUFDLENBQ25CLENBQUM7UUFDTixDQUFDLENBQUMsRUFDRixHQUFHLENBQUMsY0FBTSxPQUFBLEtBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUE1QixDQUE0QixDQUFDLENBQzFDLENBQUM7SUFDVixDQUFDO0lBRUQsa0RBQUssR0FBTDtRQUFBLGlCQU1DO1FBTEcsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDO2FBQ2xELElBQUksQ0FDRCxLQUFLLENBQUMsU0FBUyxDQUFDLEVBQ2hCLEdBQUcsQ0FBQyxjQUFNLE9BQUEsS0FBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQTVCLENBQTRCLENBQUMsQ0FDMUMsQ0FBQztJQUNWLENBQUM7SUFFRCxtREFBTSxHQUFOLFVBQU8sSUFBTztRQUFkLGlCQVlDO1FBWEcsT0FBTyxJQUFJLENBQUMsS0FBSyxFQUFFO2FBQ2QsSUFBSSxDQUNELFFBQVEsQ0FBQyxVQUFDLEdBQVc7WUFDakIsSUFBTSxVQUFVLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUVwQyxPQUFPLEtBQUksQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsS0FBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUNqRixLQUFLLENBQUMsVUFBVSxDQUFDLENBQ3BCLENBQUM7UUFDTixDQUFDLENBQUMsRUFDRixHQUFHLENBQUMsY0FBTSxPQUFBLEtBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUE1QixDQUE0QixDQUFDLENBQzFDLENBQUM7SUFDVixDQUFDO0lBRUQscURBQVEsR0FBUixVQUFTLElBQU87UUFDWixPQUFPLElBQUksQ0FBQyxLQUFLLEVBQUU7YUFDZCxJQUFJLENBQ0QsR0FBRyxDQUFDLFVBQUMsR0FBRztZQUNKLE9BQU8sR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM5QixDQUFDLENBQUMsQ0FDTCxDQUFDO0lBQ1YsQ0FBQztJQUVELG1EQUFNLEdBQU47UUFDSSxPQUFPLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQzthQUM1QyxJQUFJLENBQ0QsR0FBRyxDQUFDLFVBQUMsdUJBQXdCO1lBQ3pCLElBQUksQ0FBQyx1QkFBdUIsRUFBRTtnQkFDMUIsT0FBTyxFQUFFLENBQUM7YUFDYjtZQUVELE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO1FBQy9DLENBQUMsQ0FBQyxDQUNMLENBQUM7SUFDVixDQUFDO0lBRUQsa0RBQUssR0FBTDtRQUFBLGlCQVVDO1FBVEcsT0FBTyxJQUFJLENBQUMsTUFBTSxFQUFFO2FBQ2YsSUFBSSxDQUNELEdBQUcsQ0FBQyxVQUFDLEtBQVU7WUFDWCxPQUFPLEtBQUssQ0FBQyxNQUFNLENBQUMsVUFBQyxHQUFHLEVBQUUsSUFBSTtnQkFDMUIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDZCxPQUFPLEdBQUcsQ0FBQztZQUNmLENBQUMsRUFBRSxJQUFJLEdBQUcsQ0FBSSxLQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDO1FBQzFDLENBQUMsQ0FBQyxDQUNMLENBQUM7SUFDVixDQUFDO0lBRUQsMERBQWEsR0FBYjtRQUFBLGlCQU9DO1FBTkcsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksRUFBRTthQUM3QixJQUFJLENBQ0QsUUFBUSxDQUFDO1lBQ0wsT0FBTyxLQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDekIsQ0FBQyxDQUFDLENBQ0wsQ0FBQztJQUNWLENBQUM7SUFDTCx5Q0FBQztBQUFELENBQUMsQUFsR0QsSUFrR0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1NoYXJlZFByZWZlcmVuY2VzU2V0Q29sbGVjdGlvbn0gZnJvbSAnLi4vZGVmL3NoYXJlZC1wcmVmZXJlbmNlcy1zZXQtY29sbGVjdGlvbic7XG5pbXBvcnQge1NoYXJlZFByZWZlcmVuY2VzfSBmcm9tICcuLic7XG5pbXBvcnQge0JlaGF2aW9yU3ViamVjdCwgT2JzZXJ2YWJsZSwgU3ViamVjdH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgU2V0IGZyb20gJ3R5cGVzY3JpcHQtY29sbGVjdGlvbnMvZGlzdC9saWIvU2V0JztcbmltcG9ydCB7bWFwLCBtYXBUbywgbWVyZ2VNYXAsIHRhcH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5leHBvcnQgY2xhc3MgU2hhcmVkUHJlZmVyZW5jZXNTZXRDb2xsZWN0aW9uSW1wbDxUPiBpbXBsZW1lbnRzIFNoYXJlZFByZWZlcmVuY2VzU2V0Q29sbGVjdGlvbjxUPiB7XG4gICAgcHJpdmF0ZSBjaGFuZ2VzOiBTdWJqZWN0PHVuZGVmaW5lZD4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0PHVuZGVmaW5lZD4odW5kZWZpbmVkKTtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgc2hhcmVkUHJlZmVyZW5jZXM6IFNoYXJlZFByZWZlcmVuY2VzLCBwcml2YXRlIGtleTogc3RyaW5nLCBwcml2YXRlIHRvU3RyaW5nRnVuY3Rpb24/OiAoaXRlbTogVCkgPT4gc3RyaW5nKSB7XG4gICAgfVxuXG4gICAgYWRkQWxsKGl0ZW1zOiBUW10pOiBPYnNlcnZhYmxlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXNTZXQoKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWVyZ2VNYXAoKHNldDogU2V0PFQ+KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGl0ZW1zLmZvckVhY2goKGl0ZW0pID0+IHNldC5hZGQoaXRlbSkpO1xuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNoYXJlZFByZWZlcmVuY2VzLnB1dFN0cmluZyh0aGlzLmtleSwgSlNPTi5zdHJpbmdpZnkoc2V0LnRvQXJyYXkoKSkpLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgICAgICBtYXBUbyh1bmRlZmluZWQpXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgdGFwKCgpID0+IHRoaXMuY2hhbmdlcy5uZXh0KHVuZGVmaW5lZCkpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIGFkZChpdGVtOiBUKTogT2JzZXJ2YWJsZTx2b2lkPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmFzU2V0KClcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1lcmdlTWFwKChzZXQ6IFNldDxUPikgPT4ge1xuICAgICAgICAgICAgICAgICAgICBzZXQuYWRkKGl0ZW0pO1xuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNoYXJlZFByZWZlcmVuY2VzLnB1dFN0cmluZyh0aGlzLmtleSwgSlNPTi5zdHJpbmdpZnkoc2V0LnRvQXJyYXkoKSkpLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgICAgICBtYXBUbyh1bmRlZmluZWQpXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgdGFwKCgpID0+IHRoaXMuY2hhbmdlcy5uZXh0KHVuZGVmaW5lZCkpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIGNsZWFyKCk6IE9ic2VydmFibGU8dm9pZD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5zaGFyZWRQcmVmZXJlbmNlcy5wdXRTdHJpbmcodGhpcy5rZXksICdbXScpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXBUbyh1bmRlZmluZWQpLFxuICAgICAgICAgICAgICAgIHRhcCgoKSA9PiB0aGlzLmNoYW5nZXMubmV4dCh1bmRlZmluZWQpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICByZW1vdmUoaXRlbTogVCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5hc1NldCgpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtZXJnZU1hcCgoc2V0OiBTZXQ8VD4pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaGFzUmVtb3ZlZCA9IHNldC5yZW1vdmUoaXRlbSk7XG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2hhcmVkUHJlZmVyZW5jZXMucHV0U3RyaW5nKHRoaXMua2V5LCBKU09OLnN0cmluZ2lmeShzZXQudG9BcnJheSgpKSkucGlwZShcbiAgICAgICAgICAgICAgICAgICAgICAgIG1hcFRvKGhhc1JlbW92ZWQpXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgdGFwKCgpID0+IHRoaXMuY2hhbmdlcy5uZXh0KHVuZGVmaW5lZCkpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIGNvbnRhaW5zKGl0ZW06IFQpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXNTZXQoKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKChzZXQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNldC5jb250YWlucyhpdGVtKTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICBhc0xpc3QoKTogT2JzZXJ2YWJsZTxUW10+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2hhcmVkUHJlZmVyZW5jZXMuZ2V0U3RyaW5nKHRoaXMua2V5KVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKChkb3dubG9hZExpc3RTdHJpbmdpZmllZD8pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFkb3dubG9hZExpc3RTdHJpbmdpZmllZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFtdO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UoZG93bmxvYWRMaXN0U3RyaW5naWZpZWQpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIGFzU2V0KCk6IE9ic2VydmFibGU8U2V0PFQ+PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmFzTGlzdCgpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKGl0ZW1zOiBUW10pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGl0ZW1zLnJlZHVjZSgoYWNjLCBpdGVtKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY2MuYWRkKGl0ZW0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgICAgICAgICAgICAgICAgfSwgbmV3IFNldDxUPih0aGlzLnRvU3RyaW5nRnVuY3Rpb24pKTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICBhc0xpc3RDaGFuZ2VzKCk6IE9ic2VydmFibGU8VFtdPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmNoYW5nZXMuYXNPYnNlcnZhYmxlKClcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1lcmdlTWFwKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYXNMaXN0KCk7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICk7XG4gICAgfVxufVxuIl19